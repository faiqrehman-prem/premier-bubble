<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Voice Agent Control Panel</title>
  <script src="/socket.io/socket.io.js"></script>
  <style>
    :root {
      --bg1: #0f1226;
      --bg2: #0b1420;
      --text: #e8eaf6;
      --muted: #a5b0c2;
      --accent: #7cf7ff;
      --accent2: #a0ffcf;
      --card: rgba(255, 255, 255, 0.08);
      --cardBorder: rgba(255, 255, 255, 0.18);
      --success: #4ade80;
      --error: #ef4444;
      --warning: #f59e0b;
    }

    * {
      box-sizing: border-box;
    }

    html,
    body {
      height: 100%;
      margin: 0;
    }

    body {
      color: var(--text);
      font: 15px/1.45 system-ui, -apple-system, sans-serif;
      background: radial-gradient(1200px 700px at 10% -10%, rgba(108, 92, 231, .20), transparent 70%),
        radial-gradient(1000px 600px at 90% 10%, rgba(0, 212, 255, .18), transparent 70%),
        radial-gradient(800px 500px at 50% 110%, rgba(0, 255, 163, .15), transparent 70%),
        var(--bg1);
      min-height: 100vh;
      padding: 40px 16px;
    }

    .container {
      max-width: 1350px;
      margin: 0 auto;
      display: grid;
      gap: 24px;
    }

    .header {
      text-align: center;
    }

    .title {
      margin: 0;
      font-size: clamp(28px, 4vw, 48px);
      background: linear-gradient(90deg, var(--accent), var(--accent2));
      background-clip: text;
      -webkit-background-clip: text;
      color: transparent;
      -webkit-text-fill-color: transparent;
    }

    .badge {
      display: inline-block;
      padding: 8px 16px;
      border-radius: 999px;
      font-size: 13px;
      font-weight: 700;
      color: #06201a;
      margin-bottom: 16px;
      background: linear-gradient(90deg, var(--accent), var(--accent2));
    }

    /* User Info Styles */
    .user-info {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 24px;
      padding: 16px 20px;
      background: rgba(255, 255, 255, 0.08);
      border: 1px solid rgba(255, 255, 255, 0.18);
      border-radius: 12px;
      backdrop-filter: blur(10px);
    }

    .user-details {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .user-name {
      font-weight: 600;
      color: var(--text);
      font-size: 16px;
    }

    .user-email {
      font-size: 13px;
      color: var(--muted);
    }

    .user-actions {
      display: flex;
      gap: 8px;
    }

    .btn.small {
      padding: 6px 12px;
      font-size: 12px;
    }

    .btn.btn-danger {
      background: #ef4444;
      color: white;
    }

    .btn.btn-danger:hover {
      background: #dc2626;
    }

    .main-grid {
      display: grid;
      grid-template-columns: 1fr 400px;
      gap: 32px;
      align-items: stretch;
    }

    .card {
      padding: 24px;
      border-radius: 18px;
      background: linear-gradient(180deg, rgba(255, 255, 255, .10), rgba(255, 255, 255, .06)), var(--card);
      border: 1px solid var(--cardBorder);
      backdrop-filter: blur(8px);
    }

    .card h3 {
      margin: 0 0 16px 0;
      color: var(--accent);
    }

    .cost-tracking {
      position: relative;
    }

    .cost-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 12px;
      margin-bottom: 16px;
    }

    .cost-metric {
      background: rgba(15, 19, 35, 0.75);
      border: 1px solid rgba(255, 255, 255, 0.14);
      border-radius: 12px;
      padding: 16px;
      text-align: center;
    }

    .cost-label {
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 4px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .cost-value {
      font-size: 18px;
      font-weight: 600;
      color: var(--accent);
      font-family: ui-monospace, monospace;
    }

    .total-cost {
      background: linear-gradient(135deg, rgba(59, 130, 246, 0.15), rgba(147, 51, 234, 0.15));
      border-color: rgba(59, 130, 246, 0.3);
    }

    .total-cost .cost-value {
      font-size: 24px;
      color: #60a5fa;
    }

    .cost-status {
      font-size: 12px;
      color: var(--muted);
      text-align: center;
      padding: 8px;
      background: rgba(15, 19, 35, 0.5);
      border-radius: 8px;
      border: 1px solid rgba(255, 255, 255, 0.08);
    }

    .prompt-section {
      display: grid;
      gap: 16px;
    }

    .prompt-container {
      width: 100%;
      min-height: 280px;
      padding: 16px;
      border-radius: 14px;
      border: 1px solid rgba(255, 255, 255, .14);
      background: rgba(15, 19, 35, .75);
      color: var(--text);
      font: 14px/1.5 ui-monospace, monospace;
      outline: none;
      resize: vertical;
    }

    .controls-panel {
      display: grid;
      gap: 20px;
    }

    .control-group {
      display: grid;
      gap: 12px;
    }

    .control-group label {
      font-weight: 600;
      color: var(--accent);
      font-size: 14px;
    }

    .slider-container {
      display: grid;
      gap: 8px;
    }

    .slider {
      width: 100%;
      height: 6px;
      border-radius: 3px;
      outline: none;
      cursor: pointer;
      background: rgba(255, 255, 255, 0.1);
      appearance: none;
    }

    .slider::-webkit-slider-thumb {
      appearance: none;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: linear-gradient(45deg, var(--accent), var(--accent2));
      cursor: pointer;
      border: 2px solid #fff;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
    }

    .slider-value {
      font-family: ui-monospace, monospace;
      font-size: 13px;
      color: var(--muted);
      text-align: center;
      background: rgba(255, 255, 255, 0.05);
      padding: 4px 8px;
      border-radius: 6px;
    }

    select {
      padding: 12px 16px;
      border-radius: 10px;
      border: 1px solid rgba(255, 255, 255, .2);
      background: rgba(15, 19, 35, .85);
      color: var(--text);
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    select:hover {
      border-color: var(--accent);
      background: rgba(15, 19, 35, .95);
    }

    select:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 2px rgba(124, 247, 255, 0.2);
    }

    select option {
      background: var(--bg1);
      color: var(--text);
      padding: 8px;
    }

    .btn {
      padding: 12px 18px;
      border-radius: 12px;
      border: none;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      text-decoration: none;
      display: inline-block;
      text-align: center;
      user-select: none;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      color: #000;
      font-size: 16px;
    }

    .btn-secondary {
      background: rgba(255, 255, 255, 0.1);
      color: var(--text);
      border: 1px solid rgba(255, 255, 255, 0.2);
      font-size: 16px;
      font-weight: 600;
      padding: 14px 24px;
      min-width: 280px;
      text-align: center;
      user-select: none;
    }

    .btn-sm {
      padding: 8px 12px;
      font-size: 13px;
      min-width: auto;
    }

    .btn:hover {
      transform: translateY(-1px);
      filter: brightness(1.1);
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    .tool-list {
      display: grid;
      gap: 8px;
    }

    .tool-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
    }

    .tool-item .tool-info {
      flex: 1;
    }

    .tool-name {
      font-weight: 600;
      font-size: 15px;
    }

    .tool-desc {
      font-size: 13px;
      color: var(--muted);
      margin-top: 4px;
    }

    .toggle-switch {
      position: relative;
      display: inline-block;
      width: 40px;
      height: 22px;
      flex: 0 0 auto;
      user-select: none;
    }

    .toggle-switch input {
      position: absolute;
      opacity: 0;
      width: 0;
      height: 0;
    }

    .toggle-track {
      position: absolute;
      inset: 0;
      background: rgba(255, 255, 255, 0.18);
      border-radius: 9999px;
      transition: background .2s ease;
    }

    .toggle-thumb {
      position: absolute;
      top: 2px;
      left: 2px;
      width: 18px;
      height: 18px;
      background: #fff;
      border-radius: 50%;
      box-shadow: 0 1px 2px rgba(0, 0, 0, .25);
      transition: transform .2s ease;
    }

    .toggle-switch input:checked+.toggle-track {
      background: var(--accent);
    }

    .toggle-switch input:checked+.toggle-track .toggle-thumb {
      transform: translateX(18px);
    }

    .tool-schema-details {
      margin-top: 8px;
    }

    .tool-schema-details summary {
      cursor: pointer;
      font-size: 12px;
      color: #9ca3af;
      user-select: none;
    }

    .tool-schema-details summary:hover {
      color: var(--accent);
    }

    .tool-schema {
      background: rgba(0, 0, 0, 0.3);
      padding: 8px;
      border-radius: 4px;
      font-size: 11px;
      margin-top: 4px;
      overflow-x: auto;
      max-height: 200px;
      overflow-y: auto;
      white-space: pre-wrap;
      word-wrap: break-word;
    }

    .alert {
      padding: 12px 16px;
      border-radius: 12px;
      margin-bottom: 16px;
      background: rgba(76, 222, 128, 0.1);
      border: 1px solid var(--success);
    }

    .info-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }

    .status-indicator {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      margin-right: 8px;
      display: inline-block;
    }

    .status-active {
      background: var(--success);
    }

    .status-inactive {
      background: var(--muted);
    }

    .kb-selector {
      display: grid;
      grid-template-columns: 1fr;
      gap: 12px;
      margin-top: 16px;
      max-height: 320px;
      overflow-y: auto;
      padding-right: 8px;
      position: relative;
    }

    .prompt-card {
      display: flex;
      flex-direction: column;
      height: 100%;
    }

    .prompt-section {
      display: flex;
      flex-direction: column;
      gap: 16px;
      flex: 1;
      min-height: 0;
    }

    .prompt-container {
      flex: 1;
      min-height: 280px;
    }

    .kb-item {
      padding: 10px 14px;
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.08), rgba(255, 255, 255, 0.04));
      border-radius: 12px;
      cursor: pointer;
      border: 2px solid transparent;
      transition: all 0.3s ease;
      position: relative;
      overflow: visible;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .kb-item:hover {
      border-color: rgba(124, 247, 255, 0.5);
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
    }

    .kb-item.selected {
      border-color: var(--accent);
      background: linear-gradient(135deg, rgba(124, 247, 255, 0.15), rgba(160, 255, 207, 0.1));
      box-shadow: 0 0 20px rgba(124, 247, 255, 0.3);
    }

    .kb-checkbox {
      flex-shrink: 0;
      width: 18px;
      height: 18px;
      cursor: pointer;
    }

    .kb-title-container {
      flex: 1;
      display: flex;
      align-items: center;
      gap: 6px;
      user-select: none;
    }

    .kb-title {
      font-size: 15px;
      font-weight: 600;
      color: var(--text);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .kb-id {
      font-size: 12px;
      color: var(--muted);
      font-family: ui-monospace, monospace;
      font-weight: 600;
      user-select: text;
      margin-top: 2px;
      display: block;
    }

    .kb-info-icon {
      position: relative;
      cursor: pointer;
      user-select: none;
      font-size: 16px;
      color: var(--accent);
      padding: 2px 4px;
      border-radius: 6px;
      transition: background-color 0.2s ease;
    }

    .kb-info-icon:hover {
      background-color: rgba(124, 247, 255, 0.15);
    }

    .kb-popup {
      position: fixed;
      top: -9999px;
      left: -9999px;
      width: 380px;
      max-width: min(90vw, 420px);
      background: rgba(19, 24, 43, 0.98);
      border: 1px solid var(--cardBorder);
      border-radius: 14px;
      box-shadow: 0 18px 60px rgba(0, 0, 0, 0.45);
      padding: 16px;
      z-index: 99999;
      display: none;
    }

    .kb-popup.visible {
      display: block;
    }

    .kb-radio {
      flex-shrink: 0;
      width: 18px;
      height: 18px;
      cursor: pointer;
      accent-color: var(--accent);
    }

    .no-kb-message {
      text-align: center;
      color: #9ca3af;
      padding: 20px;
      border: 2px dashed #374151;
      border-radius: 8px;
      background: #111827;
    }

    .kb-popup::after {
      content: "";
      position: absolute;
      bottom: -8px;
      right: 16px;
      border-width: 8px 8px 0 8px;
      border-style: solid;
      border-color: rgba(19, 24, 43, 0.98) transparent transparent transparent;
      filter: drop-shadow(0 4px 6px rgba(0, 0, 0, 0.25));
    }

    .kb-popup-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 10px;
    }

    .kb-popup-title {
      font-weight: 700;
      color: var(--accent);
      font-size: 16px;
      margin-right: 12px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .kb-popup-close {
      border: 1px solid rgba(255, 255, 255, 0.2);
      background: rgba(255, 255, 255, 0.06);
      color: var(--text);
      border-radius: 8px;
      padding: 4px 8px;
      font-size: 12px;
      cursor: pointer;
    }

    .kb-popup-body {
      font-size: 14px;
      color: var(--muted);
      line-height: 1.45;
    }

    .kb-popup-meta {
      display: grid;
      gap: 6px;
      margin-top: 10px;
      font-size: 12px;
    }

    .kb-badge {
      display: inline-block;
      font-size: 11px;
      font-weight: 700;
      color: #06201a;
      padding: 4px 8px;
      border-radius: 999px;
      background: linear-gradient(90deg, var(--accent), var(--accent2));
    }

    .kb-meta-label {
      color: var(--accent);
      font-weight: 600;
    }

    .kb-popup::after {
      content: "";
      position: absolute;
      bottom: -8px;
      right: 16px;
      border-width: 8px 8px 0 8px;
      border-style: solid;
      border-color: rgba(19, 24, 43, 0.98) transparent transparent transparent;
      filter: drop-shadow(0 4px 6px rgba(0, 0, 0, 0.25));
    }

    .kb-popup-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 10px;
    }

    .kb-popup-title {
      font-weight: 700;
      color: var(--accent);
      font-size: 16px;
      margin-right: 12px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .kb-popup-close {
      border: 1px solid rgba(255, 255, 255, 0.2);
      background: rgba(255, 255, 255, 0.06);
      color: var(--text);
      border-radius: 8px;
      padding: 4px 8px;
      font-size: 12px;
      cursor: pointer;
    }

    .kb-popup-body {
      font-size: 14px;
      color: var(--muted);
      line-height: 1.45;
    }

    .kb-popup-meta {
      display: grid;
      gap: 6px;
      margin-top: 10px;
      font-size: 12px;
    }

    .kb-badge {
      display: inline-block;
      font-size: 11px;
      font-weight: 700;
      color: #06201a;
      padding: 4px 8px;
      border-radius: 999px;
      background: linear-gradient(90deg, var(--accent), var(--accent2));
    }

    .kb-meta-label {
      color: var(--accent);
      font-weight: 600;
    }

    @media (max-width: 1024px) {
      .main-grid {
        grid-template-columns: 1fr;
      }

      .kb-selector {
        grid-template-columns: 1fr;
      }
    }

    @media (max-width: 768px) {
      .kb-selector {
        grid-template-columns: 1fr;
      }
    }

    .kb-header {
      display: flex;
      align-items: center;
      justify-content: flex-start;
      gap: 15px;
      margin-bottom: 16px;
      flex-wrap: wrap;
      font-size: 15px;
      color: var(--text);
    }

    .kb-header span:first-child {
      font-weight: 600;
      color: var(--accent);
      white-space: nowrap;
    }

    .kb-current-id,
    #currentKB {
      font-family: ui-monospace, monospace;
      background: rgba(0, 0, 0, 0.35);
      border-radius: 12px;
      padding: 7px 16px;
      color: var(--accent2);
      font-weight: 700;
      user-select: text;
      font-size: 16px;
      white-space: nowrap;
      max-width: 360px;
      overflow-wrap: break-word;
      word-break: break-word;
      word-wrap: break-word;
    }

    .prompt-card form {
      display: flex;
      flex-direction: column;
      flex: 1;
      min-height: 0;
    }

    /* Domain Management Styles */
    .domain-list {
      max-height: 200px;
      overflow-y: auto;
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      background: rgba(255, 255, 255, 0.05);
    }

    .domain-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 12px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      font-size: 14px;
    }

    .domain-item:last-child {
      border-bottom: none;
    }

    .domain-item:hover {
      background: rgba(255, 255, 255, 0.05);
    }

    .domain-name {
      color: var(--text);
      font-family: 'Courier New', monospace;
    }

    .domain-remove {
      color: var(--error);
      background: none;
      border: none;
      cursor: pointer;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      transition: background-color 0.2s;
    }

    .domain-remove:hover {
      background: rgba(239, 68, 68, 0.2);
    }

    .domain-controls {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .domain-controls .toggle-switch {
      transform: scale(0.8);
    }

    .domain-status {
      font-size: 12px;
      padding: 2px 6px;
      border-radius: 4px;
      margin-left: 8px;
    }

    .domain-status.active {
      background: rgba(74, 222, 128, 0.2);
      color: var(--success);
    }

    .domain-status.error {
      background: rgba(239, 68, 68, 0.2);
      color: var(--error);
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="header">
      <div class="badge">Nova Sonic Voice Agent</div>
      <h1 class="title">Agent Control Panel</h1>
      <p>Configure your AI voice assistant for optimal performance</p>
      
      <!-- User Info Section -->
      <div class="user-info" id="userInfo" style="display: none;">
        <div class="user-details">
          <span class="user-name" id="userName">Loading...</span>
          <span class="user-email" id="userEmail"></span>
        </div>
        <div class="user-actions">
          <button id="logoutBtn" class="btn btn-danger small">üö™ Logout</button>
        </div>
      </div>
    </div>

    <div id="saveAlert" class="alert" style="display:none;">‚úÖ Configuration saved successfully!</div>

    <div class="main-grid">
      <div class="card prompt-card">
        <h3>System Prompt</h3>
        <form id="configForm">
          <div class="prompt-section">
            <textarea id="systemPrompt" name="systemPrompt" class="prompt-container"
              placeholder="Enter system prompt..."></textarea>
            <div class="info-row">
              <span style="color: var(--muted); font-size: 13px;">Characters: <span id="charCount">0</span></span>
              <div style="display: flex; gap: 12px;">
                <button type="submit" class="btn btn-primary">Save Configuration</button>
                <button type="button" id="resetBtn" class="btn btn-secondary">Reset to Default</button>
              </div>
            </div>
          </div>
        </form>
      </div>

      <div id="rightCol" style="display: grid; gap: 20px;">
        <div class="card">
          <h3>Audio Configuration</h3>
          <div class="controls-panel">
            <div class="control-group">
              <label>Voice Selection</label>
              <select id="voiceSelect" name="voice">
                <option value="matthew">Matthew (Male)</option>
                <option value="amy">Amy (Female)</option>
                <option value="tiffany">Tiffany (Female)</option>
              </select>
            </div>
            <!-- Audio Chunk Size section commented out
            <div class="control-group">
              <label>Audio Chunk Size</label>
              <div class="slider-container">
                <input type="range" id="chunkSizeSlider" class="slider" min="128" max="2048" step="64">
                <div class="slider-value"><span id="chunkSizeValue">‚Äî</span> bytes</div>
              </div>
            </div>
            -->
          </div>
        </div>

        <div class="card">
          <h3>Available Functions</h3>
          <div id="functionsList" class="tool-list"></div>
        </div>

        <div class="card">
          <h3>üõ†Ô∏è Custom Tools</h3>
          
          <!-- Add New Tool Section -->
          <div class="control-group">
            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
              <span style="font-weight: 600; color: var(--accent); font-size: 14px;">Add New Tool</span>
              <button type="button" id="refreshCustomToolsBtn" class="btn btn-secondary btn-sm">üîÑ Refresh</button>
            </div>
            
            <div class="form-group" style="margin-bottom: 12px;">
              <label style="display: block; margin-bottom: 4px; font-size: 13px; color: var(--accent2);">Tool Type:</label>
              <select id="toolType" style="width: 100%; padding: 8px; border: 1px solid rgba(255,255,255,0.2); background: rgba(0,0,0,0.3); color: white; border-radius: 4px;">
                <option value="">Select tool type...</option>
                <option value="webhook">Webhook API</option>
                <option value="script">Custom Script</option>
              </select>
            </div>
            
            <div class="form-group" style="margin-bottom: 12px;">
              <label style="display: block; margin-bottom: 4px; font-size: 13px; color: var(--accent2);">Tool Name:</label>
              <input type="text" id="toolName" placeholder="e.g., getWeatherInfo" style="width: 100%; padding: 8px; border: 1px solid rgba(255,255,255,0.2); background: rgba(0,0,0,0.3); color: white; border-radius: 4px;">
            </div>
            
            <div class="form-group" style="margin-bottom: 12px;">
              <label style="display: block; margin-bottom: 4px; font-size: 13px; color: var(--accent2);">Description:</label>
              <input type="text" id="toolDescription" placeholder="What this tool does" style="width: 100%; padding: 8px; border: 1px solid rgba(255,255,255,0.2); background: rgba(0,0,0,0.3); color: white; border-radius: 4px;">
            </div>
            
            <!-- Webhook Configuration -->
            <div id="webhookConfig" class="tool-config" style="display: none;">
              <div class="form-group" style="margin-bottom: 12px;">
                <label style="display: block; margin-bottom: 4px; font-size: 13px; color: var(--accent2);">API URL:</label>
                <input type="url" id="webhookUrl" placeholder="https://api.example.com/endpoint" style="width: 100%; padding: 8px; border: 1px solid rgba(255,255,255,0.2); background: rgba(0,0,0,0.3); color: white; border-radius: 4px;">
              </div>
              
              <div class="form-group" style="margin-bottom: 12px;">
                <label style="display: block; margin-bottom: 4px; font-size: 13px; color: var(--accent2);">HTTP Method:</label>
                <select id="webhookMethod" style="width: 100%; padding: 8px; border: 1px solid rgba(255,255,255,0.2); background: rgba(0,0,0,0.3); color: white; border-radius: 4px;">
                  <option value="GET">GET</option>
                  <option value="POST">POST</option>
                  <option value="PUT">PUT</option>
                  <option value="DELETE">DELETE</option>
                </select>
              </div>
              
              <div class="form-group" style="margin-bottom: 12px;">
                <label style="display: block; margin-bottom: 4px; font-size: 13px; color: var(--accent2);">Headers (JSON):</label>
                <textarea id="webhookHeaders" placeholder='{"Authorization": "Bearer token"}' style="width: 100%; padding: 12px; border: 1px solid rgba(255,255,255,0.2); background: rgba(0,0,0,0.5); color: #e2e8f0; border-radius: 6px; min-height: 80px; resize: vertical; font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', 'Consolas', 'source-code-pro', monospace; font-size: 13px; line-height: 1.4; box-shadow: inset 0 2px 4px rgba(0,0,0,0.2);"></textarea>
                <div style="font-size: 11px; color: var(--muted); margin-top: 4px; font-style: italic;">
                  üí° Optional: Add custom headers for authentication or API requirements
                </div>
              </div>
              
              <div class="form-group" style="margin-bottom: 12px;">
                <label style="display: block; margin-bottom: 4px; font-size: 13px; color: var(--accent2);">Input Schema (JSON):</label>
                <textarea id="webhookInputSchema" placeholder='{"type": "object", "properties": {"city": {"type": "string"}}, "required": ["city"]}' style="width: 100%; padding: 12px; border: 1px solid rgba(255,255,255,0.2); background: rgba(0,0,0,0.5); color: #e2e8f0; border-radius: 6px; min-height: 120px; resize: vertical; font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', 'Consolas', 'source-code-pro', monospace; font-size: 13px; line-height: 1.4; box-shadow: inset 0 2px 4px rgba(0,0,0,0.2);"></textarea>
                <div style="font-size: 11px; color: var(--muted); margin-top: 4px; font-style: italic;">
                  üí° Define the expected input parameters for this webhook
                </div>
              </div>
            </div>
            
            <!-- Script Configuration -->
            <div id="scriptConfig" class="tool-config" style="display: none;">
              <div class="form-group" style="margin-bottom: 12px;">
                <label style="display: block; margin-bottom: 4px; font-size: 13px; color: var(--accent2);">JavaScript Function:</label>
                <textarea id="scriptCode" placeholder="// Return data based on input args
return {
  message: 'Hello ' + args.name,
  timestamp: new Date().toISOString()
};" style="width: 100%; padding: 12px; border: 1px solid rgba(255,255,255,0.2); background: rgba(0,0,0,0.5); color: #e2e8f0; border-radius: 6px; min-height: 200px; resize: vertical; font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', 'Consolas', 'source-code-pro', monospace; font-size: 13px; line-height: 1.4; tab-size: 2; white-space: pre; overflow-wrap: normal; box-shadow: inset 0 2px 4px rgba(0,0,0,0.2);"></textarea>
                <div style="font-size: 11px; color: var(--muted); margin-top: 4px; font-style: italic;">
                  üí° Tip: Use 'args' to access input parameters. Available globals: Math, Date, JSON, console.log(), createId(), formatDate()
                </div>
              </div>
              
              <div class="form-group" style="margin-bottom: 12px;">
                <label style="display: block; margin-bottom: 4px; font-size: 13px; color: var(--accent2);">Input Schema (JSON):</label>
                <textarea id="scriptInputSchema" placeholder='{"type": "object", "properties": {"name": {"type": "string"}}, "required": ["name"]}' style="width: 100%; padding: 12px; border: 1px solid rgba(255,255,255,0.2); background: rgba(0,0,0,0.5); color: #e2e8f0; border-radius: 6px; min-height: 120px; resize: vertical; font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', 'Consolas', 'source-code-pro', monospace; font-size: 13px; line-height: 1.4; box-shadow: inset 0 2px 4px rgba(0,0,0,0.2);"></textarea>
                <div style="font-size: 11px; color: var(--muted); margin-top: 4px; font-style: italic;">
                  üí° Define the expected input parameters and their types
                </div>
              </div>
              
              <div class="form-group" style="margin-bottom: 12px;">
                <label style="display: block; margin-bottom: 4px; font-size: 13px; color: var(--accent2);">Timeout (ms):</label>
                <input type="number" id="scriptTimeout" value="10000" min="1000" max="30000" style="width: 100%; padding: 8px; border: 1px solid rgba(255,255,255,0.2); background: rgba(0,0,0,0.3); color: white; border-radius: 4px;">
              </div>
            </div>
            
            <div style="display: flex; gap: 8px; margin-top: 16px;">
              <button id="addToolBtn" class="btn btn-primary" disabled>Add Tool</button>
              <button id="testToolBtn" class="btn btn-secondary" disabled>Test Tool</button>
            </div>
            
            <div id="toolTestResult" style="margin-top: 12px; padding: 8px; border-radius: 4px; display: none;">
            </div>
          </div>
          
          <!-- Existing Tools List -->
          <div class="control-group" style="margin-top: 24px; padding-top: 24px; border-top: 1px solid rgba(255, 255, 255, 0.1);">
            <div style="font-weight: 600; color: var(--accent); font-size: 14px; margin-bottom: 12px;">Your Custom Tools</div>
            <div id="customToolsList" style="min-height: 40px;"></div>
          </div>
        </div>

        <div class="card">
          <h3>Knowledge Base Configuration</h3>
          <div id="kbRetrieveFunction" style="margin-bottom: 16px;"></div>
          <div class="control-group">
            <div class="kb-header" style="gap: 12px;">
              <span>Current KB:</span>
              <span id="currentKB">None</span>
              <button type="button" id="loadKBBtn" class="btn btn-secondary btn-sm">üîç Load Available Knowledge
                Bases</button>
            </div>
            <div id="kbSelector" class="kb-selector" style="display: none;"></div>
          </div>
          
          <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid rgba(255, 255, 255, 0.1);">
            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
              <span style="font-weight: 600; color: var(--accent); font-size: 14px;">Content Ingestion</span>
              <a href="/ingest" class="btn btn-secondary btn-sm" style="text-decoration: none;">
                üìÑ Ingest URLs
              </a>
            </div>
            <p style="font-size: 13px; color: var(--muted); margin: 0;">
              Extract text content from web pages and add them to your Knowledge Base
            </p>
          </div>
          
          <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid rgba(255, 255, 255, 0.1);">
            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
              <span style="font-weight: 600; color: var(--accent); font-size: 14px;">Recordings & Transcripts</span>
              <a href="/recordings.html" class="btn btn-secondary btn-sm" style="text-decoration: none;">
                üìÅ Browse Recordings
              </a>
            </div>
            <p style="font-size: 13px; color: var(--muted); margin: 0;">
              Browse, download, and manage transcripts and recordings
            </p>
          </div>
        </div>

        <div class="card">
          <h3>üîí Domain Authorization</h3>
          <div class="control-group">
            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
              <span style="font-weight: 600; color: var(--accent); font-size: 14px;">Authorized Domains</span>
              <button type="button" id="refreshDomainsBtn" class="btn btn-secondary btn-sm">üîÑ Refresh</button>
            </div>
            <div id="domainsList" class="domain-list" style="margin-bottom: 16px;">
              <div style="color: var(--muted); font-size: 13px;">Loading domains...</div>
            </div>
            
            <!-- Domain action feedback messages -->
            <div id="domainActionMessage" style="font-size: 12px; margin-bottom: 16px; min-height: 18px;"></div>
            
            <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid rgba(255, 255, 255, 0.1);">
              <div style="font-weight: 600; color: var(--accent2); font-size: 14px; margin-bottom: 8px;">Add New Domain</div>
              <div style="display: flex; gap: 8px;">
                <input 
                  type="text" 
                  id="newDomainInput" 
                  placeholder="example.com" 
                  style="flex: 1; padding: 8px 12px; background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 6px; color: var(--text); font-size: 14px;"
                >
                <button type="button" id="addDomainBtn" class="btn btn-primary btn-sm">Add</button>
              </div>
              <div id="domainValidationMessage" style="font-size: 12px; margin-top: 6px; min-height: 18px;">
                <span style="color: var(--muted);">Enter domain without protocol (e.g., example.com, subdomain.example.com)</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Cost Tracking Section -->
      <div class="card cost-tracking">
        <h3>üí∞ Live Usage Tracking</h3>
        
        <!-- Top Cost Display - Session and Cumulative in one row -->
        <div style="margin-bottom: 24px;">
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-bottom: 20px;">
            <div style="text-align: center; padding: 16px; background: rgba(15, 19, 35, 0.75); border: 1px solid rgba(255, 255, 255, 0.14); border-radius: 12px;">
              <div style="font-size: 16px; font-weight: 600; color: var(--accent); margin-bottom: 8px;">Current Session</div>
              <div style="font-size: 28px; font-weight: 700; color: var(--text);" id="sessionCost">$0.00</div>
              <div style="font-size: 12px; color: var(--muted); text-transform: uppercase; letter-spacing: 0.5px;">Session Cost</div>
            </div>
            <div style="text-align: center; padding: 16px; background: rgba(15, 19, 35, 0.75); border: 1px solid rgba(255, 255, 255, 0.14); border-radius: 12px;">
              <div style="font-size: 16px; font-weight: 600; color: var(--success); margin-bottom: 8px;">Cumulative Total</div>
              <div style="font-size: 28px; font-weight: 700; color: var(--text);" id="totalCost">$0.00</div>
              <div style="font-size: 12px; color: var(--muted); text-transform: uppercase; letter-spacing: 0.5px;">All-Time Cost</div>
            </div>
          </div>
          
          <!-- Silver Divider -->
          <div style="height: 2px; background: linear-gradient(90deg, transparent 0%, rgba(192, 192, 192, 0.3) 10%, rgba(192, 192, 192, 0.8) 50%, rgba(192, 192, 192, 0.3) 90%, transparent 100%); margin: 20px 0; border-radius: 1px;"></div>
        </div>
        
        <!-- Current Session Details -->
        <div style="margin-bottom: 20px;">
          <h4 style="font-size: 14px; color: var(--accent); margin-bottom: 12px;">Current Session Details</h4>
          <div class="cost-grid">
            <div class="cost-metric">
              <div class="cost-label">Speech Input</div>
              <div class="cost-value" id="speechInputTokens">0</div>
              <div style="font-size: 10px; color: var(--muted); margin-top: 2px;">tokens</div>
            </div>
            <div class="cost-metric">
              <div class="cost-label">Speech Output</div>
              <div class="cost-value" id="speechOutputTokens">0</div>
              <div style="font-size: 10px; color: var(--muted); margin-top: 2px;">tokens</div>
            </div>
            <div class="cost-metric">
              <div class="cost-label">Text Input</div>
              <div class="cost-value" id="textInputTokens">0</div>
              <div style="font-size: 10px; color: var(--muted); margin-top: 2px;">tokens</div>
            </div>
            <div class="cost-metric">
              <div class="cost-label">Text Output</div>
              <div class="cost-value" id="textOutputTokens">0</div>
              <div style="font-size: 10px; color: var(--muted); margin-top: 2px;">tokens</div>
            </div>
          </div>
        </div>
        
        <!-- Cumulative Totals Details -->
        <div style="margin-bottom: 20px;">
          <h4 style="font-size: 14px; color: var(--success); margin-bottom: 12px;">Cumulative Details (All Sessions)</h4>
          <div class="cost-grid">
            <div class="cost-metric">
              <div class="cost-label">Speech Input</div>
              <div class="cost-value" id="cumulativeSpeechInput">0</div>
              <div style="font-size: 10px; color: var(--muted); margin-top: 2px;">tokens</div>
            </div>
            <div class="cost-metric">
              <div class="cost-label">Speech Output</div>
              <div class="cost-value" id="cumulativeSpeechOutput">0</div>
              <div style="font-size: 10px; color: var(--muted); margin-top: 2px;">tokens</div>
            </div>
            <div class="cost-metric">
              <div class="cost-label">Text Input</div>
              <div class="cost-value" id="cumulativeTextInput">0</div>
              <div style="font-size: 10px; color: var(--muted); margin-top: 2px;">tokens</div>
            </div>
            <div class="cost-metric">
              <div class="cost-label">Text Output</div>
              <div class="cost-value" id="cumulativeTextOutput">0</div>
              <div style="font-size: 10px; color: var(--muted); margin-top: 2px;">tokens</div>
            </div>
            <div class="cost-metric">
              <div class="cost-label">Sessions</div>
              <div class="cost-value" id="sessionCount">0</div>
            </div>
          </div>
        </div>
        
        <div class="cost-status" id="costStatus">
          Cost tracking inactive - start server with --cost flag to enable
        </div>
      </div>
    </div>

    <script>
      const form = document.getElementById('configForm');
      const systemPrompt = document.getElementById('systemPrompt');
      const charCount = document.getElementById('charCount');
      const resetBtn = document.getElementById('resetBtn');
      const voiceSelect = document.getElementById('voiceSelect');
      // const chunkSizeSlider = document.getElementById('chunkSizeSlider');
      // const chunkSizeValue = document.getElementById('chunkSizeValue');
      const loadKBBtn = document.getElementById('loadKBBtn');
      const kbSelector = document.getElementById('kbSelector');
      const currentKB = document.getElementById('currentKB');
      const functionsList = document.getElementById('functionsList');
      const kbRetrieveFunction = document.getElementById('kbRetrieveFunction');
      const saveAlert = document.getElementById('saveAlert');

      // Cost tracking elements - Current Session
      const speechInputTokens = document.getElementById('speechInputTokens');
      const speechOutputTokens = document.getElementById('speechOutputTokens');
      const textInputTokens = document.getElementById('textInputTokens');
      const textOutputTokens = document.getElementById('textOutputTokens');
      const sessionCost = document.getElementById('sessionCost');
      
      // Cost tracking elements - Cumulative
      const cumulativeSpeechInput = document.getElementById('cumulativeSpeechInput');
      const cumulativeSpeechOutput = document.getElementById('cumulativeSpeechOutput');
      const cumulativeTextInput = document.getElementById('cumulativeTextInput');
      const cumulativeTextOutput = document.getElementById('cumulativeTextOutput');
      const totalCost = document.getElementById('totalCost');
      const sessionCount = document.getElementById('sessionCount');

      // Domain management elements
      const domainsList = document.getElementById('domainsList');
      const domainActionMessage = document.getElementById('domainActionMessage');
      const newDomainInput = document.getElementById('newDomainInput');
      const addDomainBtn = document.getElementById('addDomainBtn');
      const refreshDomainsBtn = document.getElementById('refreshDomainsBtn');
      const domainValidationMessage = document.getElementById('domainValidationMessage');
      const costStatus = document.getElementById('costStatus');

      // Socket connection for real-time cost updates
      let socket = null;
      
      function initializeCostTracking() {
        try {
          socket = io();
          
          socket.on('connect', () => {
            costStatus.textContent = 'Connected - waiting for usage data...';
            costStatus.style.color = '#22c55e';
          });
          
          socket.on('disconnect', () => {
            costStatus.textContent = 'Disconnected from server';
            costStatus.style.color = '#ef4444';
          });
          
          socket.on('costUpdate', (data) => {
            updateCostDisplay(data);
          });
          
          socket.on('cumulativeUpdate', (data) => {
            updateCumulativeDisplay(data);
          });
          
        } catch (error) {
          console.log('Socket.IO not available, cost tracking disabled');
          costStatus.textContent = 'Cost tracking unavailable - Socket.IO not loaded';
        }
      }
      
      function updateCostDisplay(data) {
        if (data.tokens) {
          speechInputTokens.textContent = data.tokens.inputSpeech || 0;
          speechOutputTokens.textContent = data.tokens.outputSpeech || 0;
          textInputTokens.textContent = data.tokens.inputText || 0;
          textOutputTokens.textContent = data.tokens.outputText || 0;
        }
        
        if (data.totalCost !== undefined) {
          sessionCost.textContent = `$${data.totalCost.toFixed(4)}`;
        }
        
        if (data.sessionActive) {
          costStatus.textContent = `Session active - ${data.sessionId || 'unknown'}`;
          costStatus.style.color = '#22c55e';
        }
      }
      
      function updateCumulativeDisplay(data) {
        if (data.cumulative) {
          const cumulative = data.cumulative;
          
          // Update cumulative token counts
          cumulativeSpeechInput.textContent = cumulative.tokens.inputSpeech || 0;
          cumulativeSpeechOutput.textContent = cumulative.tokens.outputSpeech || 0;
          cumulativeTextInput.textContent = cumulative.tokens.inputText || 0;
          cumulativeTextOutput.textContent = cumulative.tokens.outputText || 0;
          
          // Update total cost and session count
          totalCost.textContent = `$${(cumulative.totalCost || 0).toFixed(4)}`;
          sessionCount.textContent = cumulative.sessionCount || 0;
          
          // Update status if a session ended
          if (data.sessionEnded) {
            costStatus.textContent = `Session ${data.sessionEnded} ended - ${cumulative.sessionCount} total sessions`;
            costStatus.style.color = '#f59e0b';
            
            // Reset current session display
            speechInputTokens.textContent = '0';
            speechOutputTokens.textContent = '0';
            textInputTokens.textContent = '0';
            textOutputTokens.textContent = '0';
            sessionCost.textContent = '$0.00';
          }
        }
      }

      const DEFAULT_PROMPT = `You are an automated phone agent that calls an insurance carrier, navigates the IVR to the Eligibility/Benefits queue, and completes an eligibility verification with a live representative.

Patient Context (injected by the server; do not modify) 
- Patient Name: {{PATIENT_NAME}} 
- Date of Birth: {{PATIENT_DOB}} 
- Insurance/Member ID: {{INSURANCE_ID}}

Operating Rules
- Use ONLY the injected patient context and what is said on the line. Do not invent data.
- Share PHI (name, DOB, member ID) ONLY with the insurer IVR/rep and ONLY when asked or required to advance.
- Speak in short, clear sentences. No chit-chat. No small talk. Professional and concise.
- Turn-taking: wait for the other party to finish before speaking; barge in only if the IVR prompts for immediate response.
- If audio is unclear, briefly ask for repetition once, then proceed.

IVR Navigation
- Prefer speech navigation. Use phrases like "eligibility and benefits," "member eligibility," "check coverage," "representative," "speak to an agent."
- If a menu says "press 1 for eligibility," respond verbally with the exact menu phrase ("eligibility") or say "representative" if that reliably routes to an agent.
- If asked to enter data via keypad, state it clearly by voice (digits individually, with brief pauses).

Providing Patient Information
- Provide name, DOB, and member ID ONLY when asked. Format carefully:
  - Dates: say the month name, day, then year (e.g., "January 5th, 1990").
  - Member IDs: read characters one by one; for letters use the NATO alphabet (A=Alpha, B=Bravo‚Ä¶) if clarity is requested. 
- If the rep asks for information you do not have, say you do not have it available.

Goal and Completion
- Goal: Obtain a clear statement of eligibility/benefits for the patient (active/inactive status, effective dates, plan type, copay/coinsurance for office visit, deductible remaining, out-of-pocket remaining, limitations/exclusions if mentioned, and any reference number).
- When you have the information, briefly confirm key points back to the rep, thank them, and end the call.

Structured Output (for the server to save; DO NOT SPEAK this block)
- Immediately after thanking the rep (and before call teardown), output a text-only summary between these exact markers:
<ELIGIBILITY_SUMMARY_START> 
Status: <Active/Inactive/Unknown> 
Plan Type: <HMO/PPO/etc. if provided> 
Effective Dates: <start ‚Äì end> 
PCP Required: <Yes/No/Unknown> 
Office Visit Copay: <$ if provided> 
Coinsurance: <percent if provided> 
Deductible: <amount and remaining if provided> 
Out-of-Pocket Max: <amount and remaining if provided> 
Notable Limits/Exclusions: <if any stated> 
Reference Number: <if given> 
Agent/Dept: <if given> 
Notes: <any other concrete details stated by the rep> 
<ELIGIBILITY_SUMMARY_END>

Safety and Scope 
- Stay strictly on task: eligibility/benefits verification for this patient. Decline unrelated questions. 
- Never disclose PHI to anyone other than the insurer IVR/rep on this call.`;

      let currentConfig = { enabledTools: [] };

      function updateCharCount() { charCount.textContent = (systemPrompt.value || '').length.toLocaleString(); }
      // function updateChunkSize() { chunkSizeValue.textContent = chunkSizeSlider.value; }
      function showSaved() { saveAlert.style.display = 'block'; setTimeout(() => saveAlert.style.display = 'none', 3000); }

      // Authentication functions
      async function loadUserInfo() {
        try {
          const response = await fetch('/api/auth/user', { credentials: 'include' });
          if (response.ok) {
            const data = await response.json();
            if (data.authenticated && data.user) {
              document.getElementById('userName').textContent = data.user.email;
              document.getElementById('userEmail').textContent = data.user.email;
              document.getElementById('userInfo').style.display = 'flex';
            }
          }
        } catch (e) {
          console.error('Failed to load user info:', e);
        }
      }

      async function handleLogout() {
        try {
          const response = await fetch('/api/auth/logout', { method: 'POST', credentials: 'include' });
          if (response.redirected) {
            window.location.href = response.url;
          } else {
            window.location.reload();
          }
        } catch (e) {
          console.error('Logout failed:', e);
          window.location.reload();
        }
      }

      async function fetchWithAuth(url, options = {}) {
        try {
          // Ensure credentials are included to send session cookies
          const fetchOptions = {
            credentials: 'include',
            ...options
          };
          
          const response = await fetch(url, fetchOptions);
          
          if (response.status === 401) {
            const data = await response.json();
            if (data.loginUrl) {
              window.location.href = data.loginUrl;
              return null;
            }
          }
          
          return response;
        } catch (error) {
          console.error('Fetch error:', error);
          throw error;
        }
      }

      async function hydrate() {
        try {
          const [configRes, statusRes] = await Promise.all([
            fetchWithAuth('/api/config'), 
            fetchWithAuth('/api/status')
          ]);
          
          if (!configRes || !statusRes) return; // Auth redirect happened
          
          if (!configRes.ok) throw new Error('Failed to load config');
          if (!statusRes.ok) throw new Error('Failed to load status');
          
          const config = await configRes.json(); 
          await statusRes.json();
          currentConfig = config || {}; 
          if (!currentConfig.enabledTools) currentConfig.enabledTools = [];
          systemPrompt.value = config.systemPrompt || DEFAULT_PROMPT; 
          updateCharCount();
          voiceSelect.value = config.voice || 'matthew';
          currentKB.textContent = config.knowledgeBaseId || 'None';
        } catch (e) { 
          currentKB.textContent = 'Error loading'; 
        }
      }

      async function saveConfig() {
        const configData = {
          ...currentConfig,
          systemPrompt: systemPrompt.value,
          voice: voiceSelect.value,
          // chunkSize: parseInt(chunkSizeSlider.value, 10),
        };
        const response = await fetchWithAuth('/api/config', { 
          method: 'POST', 
          headers: { 'Content-Type': 'application/json' }, 
          body: JSON.stringify(configData) 
        });
        
        if (!response) return; // Auth redirect happened
        
        if (response.ok) {
          const result = await response.json();
          currentConfig = result.config;
          showSaved();
          currentKB.textContent = currentConfig.knowledgeBaseId || 'None';
        }
      }

      async function loadKnowledgeBases() {
        loadKBBtn.textContent = 'üîÑ Loading...'; 
        loadKBBtn.disabled = true; 
        kbSelector.style.display = 'none'; 
        
        try {
          // Fetch available knowledge bases from AWS
          const response = await fetch('/api/knowledge-bases', { credentials: 'include' }); 
          const data = await response.json();
          
          if (!response.ok) {
            throw new Error(data.message || 'Failed to load knowledge bases');
          }
          
          // Get current KB configuration
          const configResponse = await fetch('/api/config/knowledge-base', { credentials: 'include' });
          const currentKBConfig = await configResponse.json();
          
          kbSelector.innerHTML = '';
          
          if (data.knowledgeBases && data.knowledgeBases.length > 0) {
            data.knowledgeBases.forEach((kb) => {
              const kbItem = document.createElement('div');
              kbItem.className = 'kb-item';
              
              // Check if this is the currently selected KB
              const isSelected = currentKBConfig.selectedKnowledgeBaseId === kb.knowledgeBaseId;
              if (isSelected) kbItem.classList.add('selected');
              
              kbItem.innerHTML = `
                <input type="radio" name="kb-selection" class="kb-radio" value="${kb.knowledgeBaseId}" ${isSelected ? 'checked' : ''}/>
                <div class="kb-title-container">
                  <div style="flex:1; min-width:0;">
                    <div class="kb-title" title="${kb.name}">${kb.name || 'Unnamed Knowledge Base'}</div>
                    <div class="kb-id">ID: ${kb.knowledgeBaseId}</div>
                  </div>
                  <div class="kb-info-icon" role="button" data-kb-id="${kb.knowledgeBaseId}" data-kb-name="${kb.name}" data-kb-description="${kb.description || 'No description available'}" data-kb-status="${kb.status || 'Unknown'}">‚ÑπÔ∏è</div>
                </div>
              `;
              
              // Add click handler for the entire item
              kbItem.addEventListener('click', (e) => {
                if (e.target.type !== 'radio' && !e.target.classList.contains('kb-info-icon')) {
                  const radio = kbItem.querySelector('input[type="radio"]');
                  radio.checked = true;
                }
                if (!e.target.classList.contains('kb-info-icon')) {
                  selectKnowledgeBase(kb.knowledgeBaseId, kb.name, kbItem);
                }
              });
              
              // Add radio button change handler
              const radio = kbItem.querySelector('input[type="radio"]');
              radio.addEventListener('change', () => {
                if (radio.checked) {
                  selectKnowledgeBase(kb.knowledgeBaseId, kb.name, kbItem);
                }
              });
              
              // Add info icon click handler
              const infoIcon = kbItem.querySelector('.kb-info-icon');
              infoIcon.addEventListener('click', (e) => {
                e.stopPropagation();
                showKBInfo(e, kb);
              });
              
              kbSelector.appendChild(kbItem);
            });
            
            kbSelector.style.display = 'grid';
            
          } else {
            kbSelector.innerHTML = '<div class="no-kb-message">No knowledge bases found in your AWS account</div>';
            kbSelector.style.display = 'block';
          }
          
        } catch (e) { 
          console.error('Error loading knowledge bases:', e);
          kbSelector.innerHTML = `<div style="color:#ef4444">Error loading knowledge bases: ${e.message}</div>`; 
          kbSelector.style.display = 'block'; 
        }
        
        loadKBBtn.textContent = 'üîç Load Available Knowledge Bases'; 
        loadKBBtn.disabled = false;
      }

      async function selectKnowledgeBase(kbId, kbName, element) {
        try {
          // Update visual selection
          kbSelector.querySelectorAll('.kb-item').forEach((item) => { 
            item.classList.remove('selected');
            const radio = item.querySelector('input[type="radio"]');
            if (radio) radio.checked = false;
          });
          
          element.classList.add('selected');
          const radio = element.querySelector('input[type="radio"]');
          if (radio) radio.checked = true;
          
          // Save to server
          const response = await fetch('/api/config/knowledge-base', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({ 
              knowledgeBaseId: kbId, 
              knowledgeBaseName: kbName 
            })
          });
          
          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error || 'Failed to save KB configuration');
          }
          
          // Update the current KB display in the header
          const currentKB = document.getElementById('currentKB');
          if (currentKB) {
            currentKB.textContent = kbId;
          }
          
          showSaved();
          console.log(`Knowledge Base selected: ${kbName} (${kbId})`);
          
        } catch (error) {
          console.error('Error selecting knowledge base:', error);
          alert(`Failed to select knowledge base: ${error.message}`);
        }
      }

      function showKBInfo(event, kb) {
        // Remove any existing popup
        const existingPopup = document.querySelector('.kb-popup');
        if (existingPopup) {
          existingPopup.remove();
        }
        
        // Create popup
        const popup = document.createElement('div');
        popup.className = 'kb-popup visible';
        popup.innerHTML = `
          <div class="kb-popup-header">
            <div class="kb-popup-title">${kb.name || 'Unnamed Knowledge Base'}</div>
            <button class="kb-popup-close">‚úï</button>
          </div>
          <div class="kb-popup-body">
            ${kb.description || 'No description available'}
          </div>
          <div class="kb-popup-meta">
            <div><span class="kb-meta-label">ID:</span> <code>${kb.knowledgeBaseId}</code></div>
            <div><span class="kb-meta-label">Status:</span> <span class="kb-badge">${kb.status || 'Unknown'}</span></div>
            ${kb.createdAt ? `<div><span class="kb-meta-label">Created:</span> ${new Date(kb.createdAt).toLocaleDateString()}</div>` : ''}
          </div>
        `;
        
        document.body.appendChild(popup);
        
        // Position popup near the icon
        const iconRect = event.target.getBoundingClientRect();
        const popupRect = popup.getBoundingClientRect();
        
        let left = iconRect.left - popupRect.width + iconRect.width;
        let top = iconRect.top - popupRect.height - 10;
        
        // Adjust if popup goes off screen
        if (left < 10) left = 10;
        if (top < 10) top = iconRect.bottom + 10;
        if (left + popupRect.width > window.innerWidth - 10) {
          left = window.innerWidth - popupRect.width - 10;
        }
        
        popup.style.left = left + 'px';
        popup.style.top = top + 'px';
        
        // Add close handler
        const closeBtn = popup.querySelector('.kb-popup-close');
        const closePopup = () => popup.remove();
        closeBtn.addEventListener('click', closePopup);
        
        // Close on outside click
        setTimeout(() => {
          document.addEventListener('click', function outsideClick(e) {
            if (!popup.contains(e.target)) {
              closePopup();
              document.removeEventListener('click', outsideClick);
            }
          });
        }, 100);
      }

      async function loadFunctions() {
        try {
          const response = await fetch('/api/available-tools', { credentials: 'include' }); 
          if (!response.ok) throw new Error('Failed to load tools');
          const data = await response.json();
          
          functionsList.innerHTML = ''; 
          kbRetrieveFunction.innerHTML = '';
          
          (data.tools || []).filter(tool => tool.type === 'built-in').forEach((tool) => {
            const toolItem = document.createElement('div'); 
            toolItem.className = 'tool-item';
            toolItem.innerHTML = `
              <div class="tool-info">
                <div class="tool-name">${tool.name}</div>
                <div class="tool-desc">${tool.description || ''}</div>
                ${tool.inputSchema ? `
                  <details class="tool-schema-details">
                    <summary>Input Schema</summary>
                    <pre class="tool-schema">${JSON.stringify(tool.inputSchema, null, 2)}</pre>
                  </details>
                ` : ''}
              </div>
              <label class="toggle-switch">
                <input type="checkbox" ${tool.enabled ? 'checked' : ''} 
                       data-tool="${tool.name}" 
                       data-tool-type="${tool.type}"
                       data-tool-id="${tool.id || ''}">
                <span class="toggle-track">
                  <span class="toggle-thumb"></span>
                </span>
              </label>
            `;
            
            if (tool.name === 'retrieveFromKnowledgeBase') {
              kbRetrieveFunction.appendChild(toolItem);
            } else {
              functionsList.appendChild(toolItem);
            }
          });
          
          // Use event delegation to avoid duplicate event listeners
          // This ensures each checkbox only gets one handler regardless of how many times we reload
          
          // Update current config with loaded enabled tools (only built-in tools)
          const enabledBuiltInTools = (data.tools || []).filter(t => t.enabled && t.type === 'built-in').map(t => t.name);
          currentConfig.enabledTools = enabledBuiltInTools;
          
        } catch (e) { 
          console.error('Error loading functions:', e);
          functionsList.innerHTML = `<div style="color:#ef4444">Failed to load functions: ${e.message}</div>`; 
        }
      }

      // ---- Custom Tools Management Functions --------------------------------
      
      async function loadCustomTools() {
        try {
          const customToolsList = document.getElementById('customToolsList');
          customToolsList.innerHTML = '<div style="color: var(--muted);">Loading custom tools...</div>';
          
          const response = await fetch('/api/tools/custom', { credentials: 'include' });
          if (!response.ok) throw new Error('Failed to load custom tools');
          const data = await response.json();
          
          customToolsList.innerHTML = '';
          
          if (!data.tools || data.tools.length === 0) {
            customToolsList.innerHTML = '<div style="color: var(--muted); font-style: italic;">No custom tools created yet</div>';
            return;
          }
          
          data.tools.forEach(tool => {
            const toolElement = document.createElement('div');
            toolElement.className = 'custom-tool-item';
            toolElement.style.cssText = `
              border: 1px solid rgba(255,255,255,0.1);
              border-radius: 6px;
              padding: 12px;
              margin-bottom: 8px;
              background: rgba(0,0,0,0.2);
            `;
            
            toolElement.innerHTML = `
              <div style="display: flex; justify-content: between; align-items: flex-start; gap: 12px;">
                <div style="flex: 1;">
                  <div style="font-weight: 600; color: ${tool.enabled ? 'var(--accent)' : 'var(--muted)'}; margin-bottom: 4px;">
                    ${escapeHtml(tool.name)}
                    <span style="font-size: 11px; background: ${tool.type === 'webhook' ? '#3b82f6' : '#8b5cf6'}; color: white; padding: 2px 6px; border-radius: 3px; margin-left: 8px; font-weight: normal;">
                      ${tool.type.toUpperCase()}
                    </span>
                  </div>
                  <div style="font-size: 13px; color: var(--muted); margin-bottom: 8px;">
                    ${escapeHtml(tool.description)}
                  </div>
                  <div style="font-size: 11px; color: var(--muted);">
                    Created: ${new Date(tool.createdAt).toLocaleDateString()}
                  </div>
                </div>
                <div style="display: flex; flex-direction: column; gap: 4px; align-items: flex-end;">
                  <label class="toggle-switch" style="margin-bottom: 4px;">
                    <input type="checkbox" ${tool.enabled ? 'checked' : ''} data-tool-id="${tool.id}">
                    <span class="toggle-track">
                      <span class="toggle-thumb"></span>
                    </span>
                  </label>
                  <button class="btn btn-danger btn-sm" onclick="deleteCustomTool('${tool.id}')" style="font-size: 11px; padding: 4px 8px;">
                    üóëÔ∏è Delete
                  </button>
                </div>
              </div>
            `;
            
            customToolsList.appendChild(toolElement);
          });
          
        } catch (error) {
          console.error('Error loading custom tools:', error);
          const customToolsList = document.getElementById('customToolsList');
          customToolsList.innerHTML = `<div style="color: #ef4444;">Failed to load custom tools: ${error.message}</div>`;
        }
      }
      
      function showToolConfigForm() {
        const toolType = document.getElementById('toolType').value;
        const webhookConfig = document.getElementById('webhookConfig');
        const scriptConfig = document.getElementById('scriptConfig');
        const addBtn = document.getElementById('addToolBtn');
        const testBtn = document.getElementById('testToolBtn');
        
        // Hide all config forms
        webhookConfig.style.display = 'none';
        scriptConfig.style.display = 'none';
        
        if (toolType === 'webhook') {
          webhookConfig.style.display = 'block';
          addBtn.disabled = false;
          testBtn.disabled = false;
        } else if (toolType === 'script') {
          scriptConfig.style.display = 'block';
          addBtn.disabled = false;
          testBtn.disabled = false;
        } else {
          addBtn.disabled = true;
          testBtn.disabled = true;
        }
        
        // Clear test results
        hideToolTestResult();
      }
      
      function validateToolForm() {
        const toolType = document.getElementById('toolType').value;
        const toolName = document.getElementById('toolName').value.trim();
        const toolDescription = document.getElementById('toolDescription').value.trim();
        
        if (!toolType || !toolName || !toolDescription) {
          return { valid: false, error: 'Please fill in all required fields' };
        }
        
        if (!/^[a-zA-Z][a-zA-Z0-9_]*$/.test(toolName)) {
          return { valid: false, error: 'Tool name must start with a letter and contain only letters, numbers, and underscores' };
        }
        
        let config;
        
        if (toolType === 'webhook') {
          const url = document.getElementById('webhookUrl').value.trim();
          const method = document.getElementById('webhookMethod').value;
          const headers = document.getElementById('webhookHeaders').value.trim();
          const inputSchema = document.getElementById('webhookInputSchema').value.trim();
          
          if (!url || !method || !inputSchema) {
            return { valid: false, error: 'Please fill in all webhook configuration fields' };
          }
          
          try {
            new URL(url);
          } catch {
            return { valid: false, error: 'Please enter a valid URL' };
          }
          
          let parsedHeaders = {};
          if (headers) {
            try {
              parsedHeaders = JSON.parse(headers);
            } catch {
              return { valid: false, error: 'Headers must be valid JSON' };
            }
          }
          
          let parsedInputSchema;
          try {
            parsedInputSchema = JSON.parse(inputSchema);
          } catch {
            return { valid: false, error: 'Input schema must be valid JSON' };
          }
          
          config = {
            url,
            method,
            headers: parsedHeaders,
            inputSchema: parsedInputSchema
          };
          
        } else if (toolType === 'script') {
          const code = document.getElementById('scriptCode').value.trim();
          const inputSchema = document.getElementById('scriptInputSchema').value.trim();
          const timeout = parseInt(document.getElementById('scriptTimeout').value);
          
          if (!code || !inputSchema) {
            return { valid: false, error: 'Please fill in all script configuration fields' };
          }
          
          if (isNaN(timeout) || timeout < 1000 || timeout > 30000) {
            return { valid: false, error: 'Timeout must be between 1000 and 30000 milliseconds' };
          }
          
          let parsedInputSchema;
          try {
            parsedInputSchema = JSON.parse(inputSchema);
          } catch {
            return { valid: false, error: 'Input schema must be valid JSON' };
          }
          
          config = {
            code,
            inputSchema: parsedInputSchema,
            timeout
          };
        }
        
        return {
          valid: true,
          data: {
            name: toolName,
            description: toolDescription,
            type: toolType,
            config
          }
        };
      }
      
      async function testCustomTool() {
        const validation = validateToolForm();
        if (!validation.valid) {
          showToolTestResult(false, validation.error);
          return;
        }
        
        const testBtn = document.getElementById('testToolBtn');
        const originalText = testBtn.textContent;
        testBtn.disabled = true;
        testBtn.textContent = 'Testing...';
        
        try {
          showToolTestResult(true, 'Testing tool configuration...');
          
          const response = await fetch('/api/tools/test', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({
              type: validation.data.type,
              config: validation.data.config,
              testInput: {} // Empty test input for basic connectivity test
            })
          });
          
          const result = await response.json();
          
          if (result.success) {
            showToolTestResult(true, `‚úÖ Test successful! ${result.data ? JSON.stringify(result.data, null, 2) : 'Tool is working correctly.'}`);
          } else {
            showToolTestResult(false, `‚ùå Test failed: ${result.error}`);
          }
          
        } catch (error) {
          console.error('Error testing tool:', error);
          showToolTestResult(false, `‚ùå Test error: ${error.message}`);
        } finally {
          testBtn.disabled = false;
          testBtn.textContent = originalText;
        }
      }
      
      async function addCustomTool() {
        const validation = validateToolForm();
        if (!validation.valid) {
          alert(validation.error);
          return;
        }
        
        const addBtn = document.getElementById('addToolBtn');
        const originalText = addBtn.textContent;
        addBtn.disabled = true;
        addBtn.textContent = 'Adding...';
        
        try {
          const response = await fetch('/api/tools/custom', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify(validation.data)
          });
          
          const result = await response.json();
          
          if (result.success) {
            alert(`‚úÖ Tool "${validation.data.name}" added successfully!`);
            clearToolForm();
            await loadCustomTools();
            showSaved();
          } else {
            alert(`‚ùå Failed to add tool: ${result.error}`);
          }
          
        } catch (error) {
          console.error('Error adding tool:', error);
          alert(`‚ùå Error adding tool: ${error.message}`);
        } finally {
          addBtn.disabled = false;
          addBtn.textContent = originalText;
        }
      }
      
      async function deleteCustomTool(toolId) {
        if (!confirm('Are you sure you want to delete this tool? This action cannot be undone.')) {
          return;
        }
        
        try {
          const response = await fetch(`/api/tools/custom/${toolId}`, {
            method: 'DELETE',
            credentials: 'include'
          });
          
          const result = await response.json();
          
          if (result.success) {
            await loadCustomTools();
            showSaved();
          } else {
            alert(`‚ùå Failed to delete tool: ${result.error}`);
          }
          
        } catch (error) {
          console.error('Error deleting tool:', error);
          alert(`‚ùå Error deleting tool: ${error.message}`);
        }
      }
      
      function clearToolForm() {
        document.getElementById('toolType').value = '';
        document.getElementById('toolName').value = '';
        document.getElementById('toolDescription').value = '';
        document.getElementById('webhookUrl').value = '';
        document.getElementById('webhookMethod').value = 'GET';
        document.getElementById('webhookHeaders').value = '';
        document.getElementById('webhookInputSchema').value = '';
        document.getElementById('scriptCode').value = '';
        document.getElementById('scriptInputSchema').value = '';
        document.getElementById('scriptTimeout').value = '10000';
        
        showToolConfigForm();
        hideToolTestResult();
      }
      
      function showToolTestResult(success, message) {
        const resultDiv = document.getElementById('toolTestResult');
        resultDiv.style.display = 'block';
        resultDiv.style.background = success ? 'rgba(34, 197, 94, 0.2)' : 'rgba(239, 68, 68, 0.2)';
        resultDiv.style.borderLeft = `4px solid ${success ? '#22c55e' : '#ef4444'}`;
        resultDiv.style.color = success ? '#86efac' : '#fca5a5';
        resultDiv.innerHTML = `<pre style="white-space: pre-wrap; margin: 0; font-size: 12px;">${escapeHtml(message)}</pre>`;
      }
      
      function hideToolTestResult() {
        const resultDiv = document.getElementById('toolTestResult');
        resultDiv.style.display = 'none';
      }

      // ---- Domain Management Functions ------------------------------------
      
      function validateDomainFormat(domain) {
        // Remove protocol if accidentally included
        domain = domain.replace(/^https?:\/\//, '');
        
        // Remove trailing slash
        domain = domain.replace(/\/$/, '');
        
        // Remove port if included (we'll handle it separately)
        const domainWithoutPort = domain.split(':')[0];
        
        // Domain validation regex - requires at least one dot for web domains
        const domainRegex = /^[a-zA-Z0-9]([a-zA-Z0-9\-]{0,61}[a-zA-Z0-9])?(\.[a-zA-Z0-9]([a-zA-Z0-9\-]{0,61}[a-zA-Z0-9])?)+$/;
        
        // Check for localhost special case
        if (domain === 'localhost' || domain.startsWith('localhost:')) {
          return { valid: true, domain: domain.toLowerCase() };
        }
        
        // Check for IP addresses (basic)
        const ipRegex = /^(\d{1,3}\.){3}\d{1,3}(:\d+)?$/;
        if (ipRegex.test(domain)) {
          return { valid: true, domain: domain.toLowerCase() };
        }
        
        // Validate the domain part (without port)
        if (!domainRegex.test(domainWithoutPort)) {
          return { valid: false, error: 'Invalid domain format. Domain must contain at least one dot (e.g., example.com, subdomain.example.com)' };
        }
        
        if (domain.length > 253) {
          return { valid: false, error: 'Domain name too long (max 253 characters)' };
        }
        
        // Check for invalid characters
        if (domain.includes('..') || domain.startsWith('.') || domain.endsWith('.')) {
          return { valid: false, error: 'Domain cannot have consecutive dots or start/end with dots' };
        }
        
        return { valid: true, domain: domain.toLowerCase() };
      }

      function validateInputRealTime() {
        const domain = newDomainInput.value.trim();
        
        if (!domain) {
          domainValidationMessage.innerHTML = '<span style="color: var(--muted);">Enter domain without protocol (e.g., example.com, subdomain.example.com)</span>';
          addDomainBtn.disabled = false;
          return;
        }
        
        const validation = validateDomainFormat(domain);
        if (validation.valid) {
          domainValidationMessage.innerHTML = `<span style="color: var(--success);">‚úì Valid domain: ${validation.domain}</span>`;
          addDomainBtn.disabled = false;
        } else {
          domainValidationMessage.innerHTML = `<span style="color: var(--error);">‚úó ${validation.error}</span>`;
          addDomainBtn.disabled = true;
        }
      }

      async function loadAuthorizedDomains() {
        try {
          domainsList.innerHTML = '<div style="color: var(--muted); font-size: 13px;">Loading domains...</div>';
          
          const response = await fetch('/api/admin/domains', {
            method: 'GET',
            credentials: 'include'
          });

          if (!response.ok) {
            throw new Error(`Failed to load domains: ${response.status}`);
          }

          const data = await response.json();
          renderDomainsList(data.authorized_domains || []);
        } catch (error) {
          console.error('Error loading domains:', error);
          domainsList.innerHTML = `<div style="color: var(--error); font-size: 13px;">Error loading domains: ${error.message}</div>`;
        }
      }

      function renderDomainsList(domains) {
        if (!domains || domains.length === 0) {
          domainsList.innerHTML = '<div style="color: var(--muted); font-size: 13px; padding: 12px;">No authorized domains configured</div>';
          return;
        }

        const domainsHtml = domains.map(domainData => {
          // Handle both old string format and new object format
          const domain = typeof domainData === 'string' ? domainData : domainData.domain;
          const enabled = typeof domainData === 'string' ? true : domainData.enabled;
          
          return `
            <div class="domain-item">
              <span class="domain-name">${escapeHtml(domain)}</span>
              <div class="domain-controls">
                <label class="toggle-switch" title="Enable/Disable domain">
                  <input type="checkbox" ${enabled ? 'checked' : ''} 
                         data-domain="${escapeHtml(domain)}"
                         onchange="toggleDomain('${escapeHtml(domain)}', this.checked)">
                  <span class="toggle-track">
                    <span class="toggle-thumb"></span>
                  </span>
                </label>
                <button class="domain-remove" onclick="removeDomain('${escapeHtml(domain)}')" title="Remove domain">‚úï</button>
              </div>
            </div>
          `;
        }).join('');

        domainsList.innerHTML = domainsHtml;
      }

      function escapeHtml(unsafe) {
        return unsafe
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#039;");
      }

      async function addDomain() {
        const domain = newDomainInput.value.trim();
        
        if (!domain) {
          domainValidationMessage.innerHTML = '<span style="color: var(--error);">‚úó Please enter a domain</span>';
          newDomainInput.focus();
          return;
        }

        const validation = validateDomainFormat(domain);
        if (!validation.valid) {
          domainValidationMessage.innerHTML = `<span style="color: var(--error);">‚úó ${validation.error}</span>`;
          newDomainInput.focus();
          return;
        }

        try {
          addDomainBtn.disabled = true;
          addDomainBtn.textContent = 'Adding...';
          
          const response = await fetch('/api/admin/domains', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            credentials: 'include',
            body: JSON.stringify({ domain: validation.domain })
          });

          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error || 'Failed to add domain');
          }

          newDomainInput.value = '';
          domainValidationMessage.innerHTML = '<span style="color: var(--success);">‚úì Domain added successfully!</span>';
          
          setTimeout(() => {
            domainValidationMessage.innerHTML = '<span style="color: var(--muted);">Enter domain without protocol (e.g., example.com, subdomain.example.com)</span>';
          }, 3000);
          
          await loadAuthorizedDomains();
        } catch (error) {
          console.error('Error adding domain:', error);
          domainValidationMessage.innerHTML = `<span style="color: var(--error);">‚úó Failed to add domain: ${error.message}</span>`;
        } finally {
          addDomainBtn.disabled = false;
          addDomainBtn.textContent = 'Add';
        }
      }

      async function removeDomain(domain) {
        if (!confirm(`Remove domain "${domain}" from authorized list?`)) {
          return;
        }

        try {
          const response = await fetch('/api/admin/domains', {
            method: 'DELETE',
            headers: {
              'Content-Type': 'application/json'
            },
            credentials: 'include',
            body: JSON.stringify({ domain })
          });

          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error || 'Failed to remove domain');
          }

          await loadAuthorizedDomains();
          
          // Show success message in the domain action area temporarily
          const originalMessage = domainActionMessage.innerHTML;
          domainActionMessage.innerHTML = '<span style="color: var(--success);">‚úì Domain removed successfully!</span>';
          setTimeout(() => {
            domainActionMessage.innerHTML = originalMessage;
          }, 3000);
          
        } catch (error) {
          console.error('Error removing domain:', error);
          
          // Show error message in the domain action area temporarily
          const originalMessage = domainActionMessage.innerHTML;
          domainActionMessage.innerHTML = `<span style="color: var(--error);">‚úó Failed to remove domain: ${error.message}</span>`;
          setTimeout(() => {
            domainActionMessage.innerHTML = originalMessage;
          }, 5000);
        }
      }

      async function toggleDomain(domain, enabled) {
        try {
          const response = await fetch(`/api/admin/domains/${encodeURIComponent(domain)}/toggle`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include'
          });
          
          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error || 'Failed to toggle domain');
          }
          
          const data = await response.json();
          
          // Update the checkbox to match the actual server state
          const checkbox = document.querySelector(`[data-domain="${domain}"]`);
          if (checkbox) {
            checkbox.checked = data.enabled;
          }
          
          // Show success message
          const originalMessage = domainActionMessage.innerHTML;
          domainActionMessage.innerHTML = `<span style="color: var(--success);">‚úì Domain ${domain} ${data.enabled ? 'enabled' : 'disabled'}</span>`;
          setTimeout(() => {
            domainActionMessage.innerHTML = originalMessage;
          }, 3000);
          
        } catch (error) {
          console.error('Error toggling domain:', error);
          
          // Revert the toggle on error
          const checkbox = document.querySelector(`[data-domain="${domain}"]`);
          if (checkbox) {
            checkbox.checked = !enabled;
          }
          
          // Show error message
          const originalMessage = domainActionMessage.innerHTML;
          domainActionMessage.innerHTML = `<span style="color: var(--error);">‚úó Failed to toggle domain: ${error.message}</span>`;
          setTimeout(() => {
            domainActionMessage.innerHTML = originalMessage;
          }, 5000);
        }
      }

      systemPrompt.addEventListener('input', updateCharCount);
      // chunkSizeSlider.addEventListener('input', updateChunkSize);
      resetBtn.addEventListener('click', () => { systemPrompt.value = DEFAULT_PROMPT; updateCharCount(); });
      form.addEventListener('submit', async (e) => { e.preventDefault(); await saveConfig(); });
      loadKBBtn.addEventListener('click', loadKnowledgeBases);
      document.getElementById('logoutBtn').addEventListener('click', handleLogout);
      
      // Domain management event listeners
      addDomainBtn.addEventListener('click', addDomain);
      refreshDomainsBtn.addEventListener('click', loadAuthorizedDomains);
      newDomainInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          addDomain();
        }
      });
      
      // Real-time validation
      newDomainInput.addEventListener('input', validateInputRealTime);
      newDomainInput.addEventListener('blur', validateInputRealTime);
      
      // Custom tool management event listeners
      document.getElementById('toolType').addEventListener('change', showToolConfigForm);
      document.getElementById('addToolBtn').addEventListener('click', addCustomTool);
      document.getElementById('testToolBtn').addEventListener('click', testCustomTool);
      document.getElementById('refreshCustomToolsBtn').addEventListener('click', loadCustomTools);
      
      // Global event delegation for tool toggles - prevents duplicate event listeners
      document.addEventListener('change', async (e) => {
        // Only handle checkboxes with data-tool attribute
        if (e.target.type === 'checkbox' && e.target.dataset.tool) {
          const toolName = e.target.dataset.tool;
          const toolType = e.target.dataset.toolType;
          const toolId = e.target.dataset.toolId;
          const enabled = e.target.checked;
          
          try {
            if (toolType === 'user-defined') {
              // Handle custom tools
              if (!toolId) {
                throw new Error('Missing tool ID for custom tool');
              }
              
              const response = await fetch(`/api/tools/custom/${toolId}/toggle`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify({ enabled })
              });
              
              if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || 'Failed to toggle custom tool');
              }
              
              // Update all instances of this custom tool across both sections
              document.querySelectorAll(`[data-tool="${toolName}"][data-tool-type="user-defined"]`).forEach(cb => {
                cb.checked = enabled;
              });
              
            } else {
              // Handle built-in tools
              // Update local config
              if (enabled) { 
                if (!currentConfig.enabledTools.includes(toolName)) {
                  currentConfig.enabledTools.push(toolName); 
                }
              } else { 
                currentConfig.enabledTools = currentConfig.enabledTools.filter((t) => t !== toolName); 
              }
              
              // currentConfig.enabledTools should only contain built-in tools now
              // (since we filter them in loadFunctions), but let's be extra safe
              
              // Save tool configuration
              const response = await fetch('/api/config/tools', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify({ enabledTools: currentConfig.enabledTools })
              });
              
              if (!response.ok) {
                const errorData = await response.json();
                console.error('Server error:', errorData);
                throw new Error(errorData.error || 'Failed to save built-in tool configuration');
              }
              
              // Update all instances of this built-in tool across both sections
              document.querySelectorAll(`[data-tool="${toolName}"][data-tool-type="built-in"]`).forEach(cb => {
                cb.checked = enabled;
              });
            }
            
            showSaved();
            
          } catch (error) {
            console.error('Error toggling tool:', error);
            // Revert the toggle on error
            e.target.checked = !enabled;
            alert(`Failed to update tool: ${error.message}`);
          }
        }
      });
      
      (async function () { 
        updateCharCount(); 
        // updateChunkSize(); 
        await loadUserInfo();
        await hydrate(); 
        await loadFunctions();
        await loadCustomTools(); // Load custom tools on page load
        await loadAuthorizedDomains(); // Load domains on page load
        initializeCostTracking();
      })();
    </script>
</body>

</html>
