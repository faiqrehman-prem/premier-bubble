<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Voice Agent Control Panel</title>
  <script src="/socket.io/socket.io.js"></script>
  <style>
    :root {
      --bg1: #0f1226;
      --bg2: #0b1420;
      --text: #e8eaf6;
      --muted: #a5b0c2;
      --accent: #7cf7ff;
      --accent2: #a0ffcf;
      --card: rgba(255, 255, 255, 0.08);
      --cardBorder: rgba(255, 255, 255, 0.18);
      --success: #4ade80;
      --error: #ef4444;
      --warning: #f59e0b;
    }

    * {
      box-sizing: border-box;
    }

    html,
    body {
      height: 100%;
      margin: 0;
    }

    body {
      color: var(--text);
      font: 15px/1.45 system-ui, -apple-system, sans-serif;
      background: radial-gradient(1200px 700px at 10% -10%, rgba(108, 92, 231, .25), transparent 60%),
        radial-gradient(1000px 600px at 90% 10%, rgba(0, 212, 255, .22), transparent 60%),
        radial-gradient(800px 500px at 50% 110%, rgba(0, 255, 163, .18), transparent 60%),
        linear-gradient(180deg, var(--bg1), var(--bg2));
      min-height: 100vh;
      padding: 40px 16px;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      display: grid;
      gap: 24px;
    }

    .header {
      text-align: center;
    }

    .title {
      margin: 0;
      font-size: clamp(28px, 4vw, 48px);
      background: linear-gradient(90deg, var(--accent), var(--accent2));
      background-clip: text;
      -webkit-background-clip: text;
      color: transparent;
      -webkit-text-fill-color: transparent;
    }

    .badge {
      display: inline-block;
      padding: 8px 16px;
      border-radius: 999px;
      font-size: 13px;
      font-weight: 700;
      color: #06201a;
      margin-bottom: 16px;
      background: linear-gradient(90deg, var(--accent), var(--accent2));
    }

    /* User Info Styles */
    .user-info {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 24px;
      padding: 16px 20px;
      background: rgba(255, 255, 255, 0.08);
      border: 1px solid rgba(255, 255, 255, 0.18);
      border-radius: 12px;
      backdrop-filter: blur(10px);
    }

    .user-details {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .user-name {
      font-weight: 600;
      color: var(--text);
      font-size: 16px;
    }

    .user-email {
      font-size: 13px;
      color: var(--muted);
    }

    .user-actions {
      display: flex;
      gap: 8px;
    }

    .btn.small {
      padding: 6px 12px;
      font-size: 12px;
    }

    .btn.btn-danger {
      background: #ef4444;
      color: white;
    }

    .btn.btn-danger:hover {
      background: #dc2626;
    }

    .main-grid {
      display: grid;
      grid-template-columns: 1fr 400px;
      gap: 32px;
      align-items: stretch;
    }

    .card {
      padding: 24px;
      border-radius: 18px;
      background: linear-gradient(180deg, rgba(255, 255, 255, .10), rgba(255, 255, 255, .06)), var(--card);
      border: 1px solid var(--cardBorder);
      backdrop-filter: blur(8px);
    }

    .card h3 {
      margin: 0 0 16px 0;
      color: var(--accent);
    }

    .cost-tracking {
      position: relative;
    }

    .cost-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 12px;
      margin-bottom: 16px;
    }

    .cost-metric {
      background: rgba(15, 19, 35, 0.75);
      border: 1px solid rgba(255, 255, 255, 0.14);
      border-radius: 12px;
      padding: 16px;
      text-align: center;
    }

    .cost-label {
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 4px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .cost-value {
      font-size: 18px;
      font-weight: 600;
      color: var(--accent);
      font-family: ui-monospace, monospace;
    }

    .total-cost {
      background: linear-gradient(135deg, rgba(59, 130, 246, 0.15), rgba(147, 51, 234, 0.15));
      border-color: rgba(59, 130, 246, 0.3);
    }

    .total-cost .cost-value {
      font-size: 24px;
      color: #60a5fa;
    }

    .cost-status {
      font-size: 12px;
      color: var(--muted);
      text-align: center;
      padding: 8px;
      background: rgba(15, 19, 35, 0.5);
      border-radius: 8px;
      border: 1px solid rgba(255, 255, 255, 0.08);
    }

    .prompt-section {
      display: grid;
      gap: 16px;
    }

    .prompt-container {
      width: 100%;
      min-height: 280px;
      padding: 16px;
      border-radius: 14px;
      border: 1px solid rgba(255, 255, 255, .14);
      background: rgba(15, 19, 35, .75);
      color: var(--text);
      font: 14px/1.5 ui-monospace, monospace;
      outline: none;
      resize: vertical;
    }

    .controls-panel {
      display: grid;
      gap: 20px;
    }

    .control-group {
      display: grid;
      gap: 12px;
    }

    .control-group label {
      font-weight: 600;
      color: var(--accent);
      font-size: 14px;
    }

    .slider-container {
      display: grid;
      gap: 8px;
    }

    .slider {
      width: 100%;
      height: 6px;
      border-radius: 3px;
      outline: none;
      cursor: pointer;
      background: rgba(255, 255, 255, 0.1);
      appearance: none;
    }

    .slider::-webkit-slider-thumb {
      appearance: none;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: linear-gradient(45deg, var(--accent), var(--accent2));
      cursor: pointer;
      border: 2px solid #fff;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
    }

    .slider-value {
      font-family: ui-monospace, monospace;
      font-size: 13px;
      color: var(--muted);
      text-align: center;
      background: rgba(255, 255, 255, 0.05);
      padding: 4px 8px;
      border-radius: 6px;
    }

    select {
      padding: 12px 16px;
      border-radius: 10px;
      border: 1px solid rgba(255, 255, 255, .2);
      background: rgba(15, 19, 35, .85);
      color: var(--text);
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    select:hover {
      border-color: var(--accent);
      background: rgba(15, 19, 35, .95);
    }

    select:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 2px rgba(124, 247, 255, 0.2);
    }

    select option {
      background: var(--bg1);
      color: var(--text);
      padding: 8px;
    }

    .btn {
      padding: 12px 18px;
      border-radius: 12px;
      border: none;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      text-decoration: none;
      display: inline-block;
      text-align: center;
      user-select: none;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      color: #000;
      font-size: 16px;
    }

    .btn-secondary {
      background: rgba(255, 255, 255, 0.1);
      color: var(--text);
      border: 1px solid rgba(255, 255, 255, 0.2);
      font-size: 16px;
      font-weight: 600;
      padding: 14px 24px;
      min-width: 280px;
      text-align: center;
      user-select: none;
    }

    .btn-sm {
      padding: 8px 12px;
      font-size: 13px;
      min-width: auto;
    }

    .btn:hover {
      transform: translateY(-1px);
      filter: brightness(1.1);
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    .tool-list {
      display: grid;
      gap: 8px;
    }

    .tool-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
    }

    .tool-item .tool-info {
      flex: 1;
    }

    .tool-name {
      font-weight: 600;
      font-size: 15px;
    }

    .tool-desc {
      font-size: 13px;
      color: var(--muted);
      margin-top: 4px;
    }

    .toggle-switch {
      position: relative;
      display: inline-block;
      width: 40px;
      height: 22px;
      flex: 0 0 auto;
      user-select: none;
    }

    .toggle-switch input {
      position: absolute;
      opacity: 0;
      width: 0;
      height: 0;
    }

    .toggle-track {
      position: absolute;
      inset: 0;
      background: rgba(255, 255, 255, 0.18);
      border-radius: 9999px;
      transition: background .2s ease;
    }

    .toggle-thumb {
      position: absolute;
      top: 2px;
      left: 2px;
      width: 18px;
      height: 18px;
      background: #fff;
      border-radius: 50%;
      box-shadow: 0 1px 2px rgba(0, 0, 0, .25);
      transition: transform .2s ease;
    }

    .toggle-switch input:checked+.toggle-track {
      background: var(--accent);
    }

    .toggle-switch input:checked+.toggle-track .toggle-thumb {
      transform: translateX(18px);
    }

    .tool-schema-details {
      margin-top: 8px;
    }

    .tool-schema-details summary {
      cursor: pointer;
      font-size: 12px;
      color: #9ca3af;
      user-select: none;
    }

    .tool-schema-details summary:hover {
      color: var(--accent);
    }

    .tool-schema {
      background: rgba(0, 0, 0, 0.3);
      padding: 8px;
      border-radius: 4px;
      font-size: 11px;
      margin-top: 4px;
      overflow-x: auto;
      max-height: 200px;
      overflow-y: auto;
      white-space: pre-wrap;
      word-wrap: break-word;
    }

    .alert {
      padding: 12px 16px;
      border-radius: 12px;
      margin-bottom: 16px;
      background: rgba(76, 222, 128, 0.1);
      border: 1px solid var(--success);
    }

    .info-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }

    .status-indicator {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      margin-right: 8px;
      display: inline-block;
    }

    .status-active {
      background: var(--success);
    }

    .status-inactive {
      background: var(--muted);
    }

    .kb-selector {
      display: grid;
      grid-template-columns: 1fr;
      gap: 12px;
      margin-top: 16px;
      max-height: 320px;
      overflow-y: auto;
      padding-right: 8px;
      position: relative;
    }

    .prompt-card {
      display: flex;
      flex-direction: column;
      height: 100%;
    }

    .prompt-section {
      display: flex;
      flex-direction: column;
      gap: 16px;
      flex: 1;
      min-height: 0;
    }

    .prompt-container {
      flex: 1;
      min-height: 280px;
    }

    .kb-item {
      padding: 10px 14px;
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.08), rgba(255, 255, 255, 0.04));
      border-radius: 12px;
      cursor: pointer;
      border: 2px solid transparent;
      transition: all 0.3s ease;
      position: relative;
      overflow: visible;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .kb-item:hover {
      border-color: rgba(124, 247, 255, 0.5);
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
    }

    .kb-item.selected {
      border-color: var(--accent);
      background: linear-gradient(135deg, rgba(124, 247, 255, 0.15), rgba(160, 255, 207, 0.1));
      box-shadow: 0 0 20px rgba(124, 247, 255, 0.3);
    }

    .kb-checkbox {
      flex-shrink: 0;
      width: 18px;
      height: 18px;
      cursor: pointer;
    }

    .kb-title-container {
      flex: 1;
      display: flex;
      align-items: center;
      gap: 6px;
      user-select: none;
    }

    .kb-title {
      font-size: 15px;
      font-weight: 600;
      color: var(--text);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .kb-id {
      font-size: 12px;
      color: var(--muted);
      font-family: ui-monospace, monospace;
      font-weight: 600;
      user-select: text;
      margin-top: 2px;
      display: block;
    }

    .kb-info-icon {
      position: relative;
      cursor: pointer;
      user-select: none;
      font-size: 16px;
      color: var(--accent);
      padding: 2px 4px;
      border-radius: 6px;
      transition: background-color 0.2s ease;
    }

    .kb-info-icon:hover {
      background-color: rgba(124, 247, 255, 0.15);
    }

    .kb-popup {
      position: fixed;
      top: -9999px;
      left: -9999px;
      width: 380px;
      max-width: min(90vw, 420px);
      background: rgba(19, 24, 43, 0.98);
      border: 1px solid var(--cardBorder);
      border-radius: 14px;
      box-shadow: 0 18px 60px rgba(0, 0, 0, 0.45);
      padding: 16px;
      z-index: 99999;
      display: none;
    }

    .kb-popup.visible {
      display: block;
    }

    .kb-radio {
      flex-shrink: 0;
      width: 18px;
      height: 18px;
      cursor: pointer;
      accent-color: var(--accent);
    }

    .no-kb-message {
      text-align: center;
      color: #9ca3af;
      padding: 20px;
      border: 2px dashed #374151;
      border-radius: 8px;
      background: #111827;
    }

    .kb-popup::after {
      content: "";
      position: absolute;
      bottom: -8px;
      right: 16px;
      border-width: 8px 8px 0 8px;
      border-style: solid;
      border-color: rgba(19, 24, 43, 0.98) transparent transparent transparent;
      filter: drop-shadow(0 4px 6px rgba(0, 0, 0, 0.25));
    }

    .kb-popup-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 10px;
    }

    .kb-popup-title {
      font-weight: 700;
      color: var(--accent);
      font-size: 16px;
      margin-right: 12px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .kb-popup-close {
      border: 1px solid rgba(255, 255, 255, 0.2);
      background: rgba(255, 255, 255, 0.06);
      color: var(--text);
      border-radius: 8px;
      padding: 4px 8px;
      font-size: 12px;
      cursor: pointer;
    }

    .kb-popup-body {
      font-size: 14px;
      color: var(--muted);
      line-height: 1.45;
    }

    .kb-popup-meta {
      display: grid;
      gap: 6px;
      margin-top: 10px;
      font-size: 12px;
    }

    .kb-badge {
      display: inline-block;
      font-size: 11px;
      font-weight: 700;
      color: #06201a;
      padding: 4px 8px;
      border-radius: 999px;
      background: linear-gradient(90deg, var(--accent), var(--accent2));
    }

    .kb-meta-label {
      color: var(--accent);
      font-weight: 600;
    }

    .kb-popup::after {
      content: "";
      position: absolute;
      bottom: -8px;
      right: 16px;
      border-width: 8px 8px 0 8px;
      border-style: solid;
      border-color: rgba(19, 24, 43, 0.98) transparent transparent transparent;
      filter: drop-shadow(0 4px 6px rgba(0, 0, 0, 0.25));
    }

    .kb-popup-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 10px;
    }

    .kb-popup-title {
      font-weight: 700;
      color: var(--accent);
      font-size: 16px;
      margin-right: 12px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .kb-popup-close {
      border: 1px solid rgba(255, 255, 255, 0.2);
      background: rgba(255, 255, 255, 0.06);
      color: var(--text);
      border-radius: 8px;
      padding: 4px 8px;
      font-size: 12px;
      cursor: pointer;
    }

    .kb-popup-body {
      font-size: 14px;
      color: var(--muted);
      line-height: 1.45;
    }

    .kb-popup-meta {
      display: grid;
      gap: 6px;
      margin-top: 10px;
      font-size: 12px;
    }

    .kb-badge {
      display: inline-block;
      font-size: 11px;
      font-weight: 700;
      color: #06201a;
      padding: 4px 8px;
      border-radius: 999px;
      background: linear-gradient(90deg, var(--accent), var(--accent2));
    }

    .kb-meta-label {
      color: var(--accent);
      font-weight: 600;
    }

    @media (max-width: 1024px) {
      .main-grid {
        grid-template-columns: 1fr;
      }

      .kb-selector {
        grid-template-columns: 1fr;
      }
    }

    @media (max-width: 768px) {
      .kb-selector {
        grid-template-columns: 1fr;
      }
    }

    .kb-header {
      display: flex;
      align-items: center;
      justify-content: flex-start;
      gap: 15px;
      margin-bottom: 16px;
      flex-wrap: wrap;
      font-size: 15px;
      color: var(--text);
    }

    .kb-header span:first-child {
      font-weight: 600;
      color: var(--accent);
      white-space: nowrap;
    }

    .kb-current-id,
    #currentKB {
      font-family: ui-monospace, monospace;
      background: rgba(0, 0, 0, 0.35);
      border-radius: 12px;
      padding: 7px 16px;
      color: var(--accent2);
      font-weight: 700;
      user-select: text;
      font-size: 16px;
      white-space: nowrap;
      max-width: 360px;
      overflow-wrap: break-word;
      word-break: break-word;
      word-wrap: break-word;
    }

    .prompt-card form {
      display: flex;
      flex-direction: column;
      flex: 1;
      min-height: 0;
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="header">
      <div class="badge">Nova Sonic Voice Agent</div>
      <h1 class="title">Agent Control Panel</h1>
      <p>Configure your AI voice assistant for optimal performance</p>
      
      <!-- User Info Section -->
      <div class="user-info" id="userInfo" style="display: none;">
        <div class="user-details">
          <span class="user-name" id="userName">Loading...</span>
          <span class="user-email" id="userEmail"></span>
        </div>
        <div class="user-actions">
          <a href="/ingest" class="btn btn-secondary small">üìÅ Ingestion</a>
          <button id="logoutBtn" class="btn btn-danger small">üö™ Logout</button>
        </div>
      </div>
    </div>

    <div id="saveAlert" class="alert" style="display:none;">‚úÖ Configuration saved successfully!</div>

    <div class="main-grid">
      <div class="card prompt-card">
        <h3>System Prompt</h3>
        <form id="configForm">
          <div class="prompt-section">
            <textarea id="systemPrompt" name="systemPrompt" class="prompt-container"
              placeholder="Enter system prompt..."></textarea>
            <div class="info-row">
              <span style="color: var(--muted); font-size: 13px;">Characters: <span id="charCount">0</span></span>
              <div style="display: flex; gap: 12px;">
                <button type="submit" class="btn btn-primary">Save Configuration</button>
                <button type="button" id="resetBtn" class="btn btn-secondary">Reset to Default</button>
              </div>
            </div>
          </div>
        </form>
      </div>

      <div id="rightCol" style="display: grid; gap: 20px;">
        <div class="card">
          <h3>Audio Configuration</h3>
          <div class="controls-panel">
            <div class="control-group">
              <label>Voice Selection</label>
              <select id="voiceSelect" name="voice">
                <option value="matthew">Matthew (Male)</option>
                <option value="amy">Amy (Female)</option>
                <option value="tiffany">Tiffany (Female)</option>
              </select>
            </div>
            <!-- Audio Chunk Size section commented out
            <div class="control-group">
              <label>Audio Chunk Size</label>
              <div class="slider-container">
                <input type="range" id="chunkSizeSlider" class="slider" min="128" max="2048" step="64">
                <div class="slider-value"><span id="chunkSizeValue">‚Äî</span> bytes</div>
              </div>
            </div>
            -->
          </div>
        </div>

        <div class="card">
          <h3>Available Functions</h3>
          <div id="functionsList" class="tool-list"></div>
        </div>

        <div class="card">
          <h3>Knowledge Base Configuration</h3>
          <div id="kbRetrieveFunction" style="margin-bottom: 16px;"></div>
          <div class="control-group">
            <div class="kb-header" style="gap: 12px;">
              <span>Current KB:</span>
              <span id="currentKB">None</span>
              <button type="button" id="loadKBBtn" class="btn btn-secondary btn-sm">üîç Load Available Knowledge
                Bases</button>
            </div>
            <div id="kbSelector" class="kb-selector" style="display: none;"></div>
          </div>
          
          <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid rgba(255, 255, 255, 0.1);">
            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
              <span style="font-weight: 600; color: var(--accent); font-size: 14px;">Content Ingestion</span>
              <a href="/ingest" class="btn btn-secondary btn-sm" style="text-decoration: none;">
                üìÑ Ingest URLs
              </a>
            </div>
            <p style="font-size: 13px; color: var(--muted); margin: 0;">
              Extract text content from web pages and add them to your Knowledge Base
            </p>
          </div>
        </div>
      </div>

      <!-- Cost Tracking Section -->
      <div class="card cost-tracking">
        <h3>üí∞ Live Usage Tracking</h3>
        
        <!-- Top Cost Display - Session and Cumulative in one row -->
        <div style="margin-bottom: 24px;">
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-bottom: 20px;">
            <div style="text-align: center; padding: 16px; background: rgba(15, 19, 35, 0.75); border: 1px solid rgba(255, 255, 255, 0.14); border-radius: 12px;">
              <div style="font-size: 16px; font-weight: 600; color: var(--accent); margin-bottom: 8px;">Current Session</div>
              <div style="font-size: 28px; font-weight: 700; color: var(--text);" id="sessionCost">$0.00</div>
              <div style="font-size: 12px; color: var(--muted); text-transform: uppercase; letter-spacing: 0.5px;">Session Cost</div>
            </div>
            <div style="text-align: center; padding: 16px; background: rgba(15, 19, 35, 0.75); border: 1px solid rgba(255, 255, 255, 0.14); border-radius: 12px;">
              <div style="font-size: 16px; font-weight: 600; color: var(--success); margin-bottom: 8px;">Cumulative Total</div>
              <div style="font-size: 28px; font-weight: 700; color: var(--text);" id="totalCost">$0.00</div>
              <div style="font-size: 12px; color: var(--muted); text-transform: uppercase; letter-spacing: 0.5px;">All-Time Cost</div>
            </div>
          </div>
          
          <!-- Silver Divider -->
          <div style="height: 2px; background: linear-gradient(90deg, transparent 0%, rgba(192, 192, 192, 0.3) 10%, rgba(192, 192, 192, 0.8) 50%, rgba(192, 192, 192, 0.3) 90%, transparent 100%); margin: 20px 0; border-radius: 1px;"></div>
        </div>
        
        <!-- Current Session Details -->
        <div style="margin-bottom: 20px;">
          <h4 style="font-size: 14px; color: var(--accent); margin-bottom: 12px;">Current Session Details</h4>
          <div class="cost-grid">
            <div class="cost-metric">
              <div class="cost-label">Speech Input</div>
              <div class="cost-value" id="speechInputTokens">0</div>
              <div style="font-size: 10px; color: var(--muted); margin-top: 2px;">tokens</div>
            </div>
            <div class="cost-metric">
              <div class="cost-label">Speech Output</div>
              <div class="cost-value" id="speechOutputTokens">0</div>
              <div style="font-size: 10px; color: var(--muted); margin-top: 2px;">tokens</div>
            </div>
            <div class="cost-metric">
              <div class="cost-label">Text Input</div>
              <div class="cost-value" id="textInputTokens">0</div>
              <div style="font-size: 10px; color: var(--muted); margin-top: 2px;">tokens</div>
            </div>
            <div class="cost-metric">
              <div class="cost-label">Text Output</div>
              <div class="cost-value" id="textOutputTokens">0</div>
              <div style="font-size: 10px; color: var(--muted); margin-top: 2px;">tokens</div>
            </div>
          </div>
        </div>
        
        <!-- Cumulative Totals Details -->
        <div style="margin-bottom: 20px;">
          <h4 style="font-size: 14px; color: var(--success); margin-bottom: 12px;">Cumulative Details (All Sessions)</h4>
          <div class="cost-grid">
            <div class="cost-metric">
              <div class="cost-label">Speech Input</div>
              <div class="cost-value" id="cumulativeSpeechInput">0</div>
              <div style="font-size: 10px; color: var(--muted); margin-top: 2px;">tokens</div>
            </div>
            <div class="cost-metric">
              <div class="cost-label">Speech Output</div>
              <div class="cost-value" id="cumulativeSpeechOutput">0</div>
              <div style="font-size: 10px; color: var(--muted); margin-top: 2px;">tokens</div>
            </div>
            <div class="cost-metric">
              <div class="cost-label">Text Input</div>
              <div class="cost-value" id="cumulativeTextInput">0</div>
              <div style="font-size: 10px; color: var(--muted); margin-top: 2px;">tokens</div>
            </div>
            <div class="cost-metric">
              <div class="cost-label">Text Output</div>
              <div class="cost-value" id="cumulativeTextOutput">0</div>
              <div style="font-size: 10px; color: var(--muted); margin-top: 2px;">tokens</div>
            </div>
            <div class="cost-metric">
              <div class="cost-label">Sessions</div>
              <div class="cost-value" id="sessionCount">0</div>
            </div>
          </div>
        </div>
        
        <div class="cost-status" id="costStatus">
          Cost tracking inactive - start server with --cost flag to enable
        </div>
      </div>
    </div>

    <script>
      const form = document.getElementById('configForm');
      const systemPrompt = document.getElementById('systemPrompt');
      const charCount = document.getElementById('charCount');
      const resetBtn = document.getElementById('resetBtn');
      const voiceSelect = document.getElementById('voiceSelect');
      // const chunkSizeSlider = document.getElementById('chunkSizeSlider');
      // const chunkSizeValue = document.getElementById('chunkSizeValue');
      const loadKBBtn = document.getElementById('loadKBBtn');
      const kbSelector = document.getElementById('kbSelector');
      const currentKB = document.getElementById('currentKB');
      const functionsList = document.getElementById('functionsList');
      const kbRetrieveFunction = document.getElementById('kbRetrieveFunction');
      const saveAlert = document.getElementById('saveAlert');

      // Cost tracking elements - Current Session
      const speechInputTokens = document.getElementById('speechInputTokens');
      const speechOutputTokens = document.getElementById('speechOutputTokens');
      const textInputTokens = document.getElementById('textInputTokens');
      const textOutputTokens = document.getElementById('textOutputTokens');
      const sessionCost = document.getElementById('sessionCost');
      
      // Cost tracking elements - Cumulative
      const cumulativeSpeechInput = document.getElementById('cumulativeSpeechInput');
      const cumulativeSpeechOutput = document.getElementById('cumulativeSpeechOutput');
      const cumulativeTextInput = document.getElementById('cumulativeTextInput');
      const cumulativeTextOutput = document.getElementById('cumulativeTextOutput');
      const totalCost = document.getElementById('totalCost');
      const sessionCount = document.getElementById('sessionCount');
      const costStatus = document.getElementById('costStatus');

      // Socket connection for real-time cost updates
      let socket = null;
      
      function initializeCostTracking() {
        try {
          socket = io();
          
          socket.on('connect', () => {
            costStatus.textContent = 'Connected - waiting for usage data...';
            costStatus.style.color = '#22c55e';
          });
          
          socket.on('disconnect', () => {
            costStatus.textContent = 'Disconnected from server';
            costStatus.style.color = '#ef4444';
          });
          
          socket.on('costUpdate', (data) => {
            updateCostDisplay(data);
          });
          
          socket.on('cumulativeUpdate', (data) => {
            updateCumulativeDisplay(data);
          });
          
        } catch (error) {
          console.log('Socket.IO not available, cost tracking disabled');
          costStatus.textContent = 'Cost tracking unavailable - Socket.IO not loaded';
        }
      }
      
      function updateCostDisplay(data) {
        if (data.tokens) {
          speechInputTokens.textContent = data.tokens.inputSpeech || 0;
          speechOutputTokens.textContent = data.tokens.outputSpeech || 0;
          textInputTokens.textContent = data.tokens.inputText || 0;
          textOutputTokens.textContent = data.tokens.outputText || 0;
        }
        
        if (data.totalCost !== undefined) {
          sessionCost.textContent = `$${data.totalCost.toFixed(4)}`;
        }
        
        if (data.sessionActive) {
          costStatus.textContent = `Session active - ${data.sessionId || 'unknown'}`;
          costStatus.style.color = '#22c55e';
        }
      }
      
      function updateCumulativeDisplay(data) {
        if (data.cumulative) {
          const cumulative = data.cumulative;
          
          // Update cumulative token counts
          cumulativeSpeechInput.textContent = cumulative.tokens.inputSpeech || 0;
          cumulativeSpeechOutput.textContent = cumulative.tokens.outputSpeech || 0;
          cumulativeTextInput.textContent = cumulative.tokens.inputText || 0;
          cumulativeTextOutput.textContent = cumulative.tokens.outputText || 0;
          
          // Update total cost and session count
          totalCost.textContent = `$${(cumulative.totalCost || 0).toFixed(4)}`;
          sessionCount.textContent = cumulative.sessionCount || 0;
          
          // Update status if a session ended
          if (data.sessionEnded) {
            costStatus.textContent = `Session ${data.sessionEnded} ended - ${cumulative.sessionCount} total sessions`;
            costStatus.style.color = '#f59e0b';
            
            // Reset current session display
            speechInputTokens.textContent = '0';
            speechOutputTokens.textContent = '0';
            textInputTokens.textContent = '0';
            textOutputTokens.textContent = '0';
            sessionCost.textContent = '$0.00';
          }
        }
      }

      const DEFAULT_PROMPT = `You are an automated phone agent that calls an insurance carrier, navigates the IVR to the Eligibility/Benefits queue, and completes an eligibility verification with a live representative.

Patient Context (injected by the server; do not modify) 
- Patient Name: {{PATIENT_NAME}} 
- Date of Birth: {{PATIENT_DOB}} 
- Insurance/Member ID: {{INSURANCE_ID}}

Operating Rules
- Use ONLY the injected patient context and what is said on the line. Do not invent data.
- Share PHI (name, DOB, member ID) ONLY with the insurer IVR/rep and ONLY when asked or required to advance.
- Speak in short, clear sentences. No chit-chat. No small talk. Professional and concise.
- Turn-taking: wait for the other party to finish before speaking; barge in only if the IVR prompts for immediate response.
- If audio is unclear, briefly ask for repetition once, then proceed.

IVR Navigation
- Prefer speech navigation. Use phrases like "eligibility and benefits," "member eligibility," "check coverage," "representative," "speak to an agent."
- If a menu says "press 1 for eligibility," respond verbally with the exact menu phrase ("eligibility") or say "representative" if that reliably routes to an agent.
- If asked to enter data via keypad, state it clearly by voice (digits individually, with brief pauses).

Providing Patient Information
- Provide name, DOB, and member ID ONLY when asked. Format carefully:
  - Dates: say the month name, day, then year (e.g., "January 5th, 1990").
  - Member IDs: read characters one by one; for letters use the NATO alphabet (A=Alpha, B=Bravo‚Ä¶) if clarity is requested. 
- If the rep asks for information you do not have, say you do not have it available.

Goal and Completion
- Goal: Obtain a clear statement of eligibility/benefits for the patient (active/inactive status, effective dates, plan type, copay/coinsurance for office visit, deductible remaining, out-of-pocket remaining, limitations/exclusions if mentioned, and any reference number).
- When you have the information, briefly confirm key points back to the rep, thank them, and end the call.

Structured Output (for the server to save; DO NOT SPEAK this block)
- Immediately after thanking the rep (and before call teardown), output a text-only summary between these exact markers:
<ELIGIBILITY_SUMMARY_START> 
Status: <Active/Inactive/Unknown> 
Plan Type: <HMO/PPO/etc. if provided> 
Effective Dates: <start ‚Äì end> 
PCP Required: <Yes/No/Unknown> 
Office Visit Copay: <$ if provided> 
Coinsurance: <percent if provided> 
Deductible: <amount and remaining if provided> 
Out-of-Pocket Max: <amount and remaining if provided> 
Notable Limits/Exclusions: <if any stated> 
Reference Number: <if given> 
Agent/Dept: <if given> 
Notes: <any other concrete details stated by the rep> 
<ELIGIBILITY_SUMMARY_END>

Safety and Scope 
- Stay strictly on task: eligibility/benefits verification for this patient. Decline unrelated questions. 
- Never disclose PHI to anyone other than the insurer IVR/rep on this call.`;

      let currentConfig = { enabledTools: [] };

      function updateCharCount() { charCount.textContent = (systemPrompt.value || '').length.toLocaleString(); }
      // function updateChunkSize() { chunkSizeValue.textContent = chunkSizeSlider.value; }
      function showSaved() { saveAlert.style.display = 'block'; setTimeout(() => saveAlert.style.display = 'none', 3000); }

      // Authentication functions
      async function loadUserInfo() {
        try {
          const response = await fetch('/api/auth/user');
          if (response.ok) {
            const data = await response.json();
            if (data.authenticated && data.user) {
              document.getElementById('userName').textContent = data.user.name;
              document.getElementById('userEmail').textContent = data.user.email;
              document.getElementById('userInfo').style.display = 'flex';
            }
          }
        } catch (e) {
          console.error('Failed to load user info:', e);
        }
      }

      async function handleLogout() {
        try {
          const response = await fetch('/api/auth/logout', { method: 'POST' });
          if (response.redirected) {
            window.location.href = response.url;
          } else {
            window.location.reload();
          }
        } catch (e) {
          console.error('Logout failed:', e);
          window.location.reload();
        }
      }

      async function loadUserInfo() {
        try {
          const response = await fetch('/api/auth/user');
          const data = await response.json();
          
          if (data.authenticated && data.user) {
            document.getElementById('userName').textContent = data.user.name;
            document.getElementById('userEmail').textContent = data.user.email;
            document.getElementById('userInfo').style.display = 'flex';
            document.getElementById('logoutBtn').style.display = 'inline-flex';
          } else if (response.status === 401) {
            // Redirect to login if not authenticated
            window.location.href = data.loginUrl || 'https://portal.premiernx.com/login';
          }
        } catch (error) {
          console.error('Error loading user info:', error);
        }
      }

      async function handleLogout() {
        try {
          const response = await fetch('/api/auth/logout', { method: 'POST' });
          if (response.redirected) {
            window.location.href = response.url;
          } else {
            window.location.href = 'https://portal.premiernx.com/login';
          }
        } catch (error) {
          console.error('Logout error:', error);
          window.location.href = 'https://portal.premiernx.com/login';
        }
      }

      async function fetchWithAuth(url, options = {}) {
        try {
          const response = await fetch(url, options);
          
          if (response.status === 401) {
            const data = await response.json();
            if (data.loginUrl) {
              window.location.href = data.loginUrl;
              return null;
            }
          }
          
          return response;
        } catch (error) {
          console.error('Fetch error:', error);
          throw error;
        }
      }

      async function hydrate() {
        try {
          const [configRes, statusRes] = await Promise.all([
            fetchWithAuth('/api/config'), 
            fetchWithAuth('/api/status')
          ]);
          
          if (!configRes || !statusRes) return; // Auth redirect happened
          
          if (!configRes.ok) throw new Error('Failed to load config');
          if (!statusRes.ok) throw new Error('Failed to load status');
          
          const config = await configRes.json(); 
          await statusRes.json();
          currentConfig = config || {}; 
          if (!currentConfig.enabledTools) currentConfig.enabledTools = [];
          systemPrompt.value = config.systemPrompt || DEFAULT_PROMPT; 
          updateCharCount();
          voiceSelect.value = config.voice || 'matthew';
          currentKB.textContent = config.knowledgeBaseId || 'None';
        } catch (e) { 
          currentKB.textContent = 'Error loading'; 
        }
      }

      async function saveConfig() {
        const configData = {
          ...currentConfig,
          systemPrompt: systemPrompt.value,
          voice: voiceSelect.value,
          // chunkSize: parseInt(chunkSizeSlider.value, 10),
        };
        const response = await fetchWithAuth('/api/config', { 
          method: 'POST', 
          headers: { 'Content-Type': 'application/json' }, 
          body: JSON.stringify(configData) 
        });
        
        if (!response) return; // Auth redirect happened
        
        if (response.ok) {
          const result = await response.json();
          currentConfig = result.config;
          showSaved();
          currentKB.textContent = currentConfig.knowledgeBaseId || 'None';
        }
      }

      async function loadKnowledgeBases() {
        loadKBBtn.textContent = 'üîÑ Loading...'; 
        loadKBBtn.disabled = true; 
        kbSelector.style.display = 'none'; 
        
        try {
          // Fetch available knowledge bases from AWS
          const response = await fetch('/api/knowledge-bases'); 
          const data = await response.json();
          
          if (!response.ok) {
            throw new Error(data.message || 'Failed to load knowledge bases');
          }
          
          // Get current KB configuration
          const configResponse = await fetch('/api/config/knowledge-base');
          const currentKBConfig = await configResponse.json();
          
          kbSelector.innerHTML = '';
          
          if (data.knowledgeBases && data.knowledgeBases.length > 0) {
            data.knowledgeBases.forEach((kb) => {
              const kbItem = document.createElement('div');
              kbItem.className = 'kb-item';
              
              // Check if this is the currently selected KB
              const isSelected = currentKBConfig.selectedKnowledgeBaseId === kb.knowledgeBaseId;
              if (isSelected) kbItem.classList.add('selected');
              
              kbItem.innerHTML = `
                <input type="radio" name="kb-selection" class="kb-radio" value="${kb.knowledgeBaseId}" ${isSelected ? 'checked' : ''}/>
                <div class="kb-title-container">
                  <div style="flex:1; min-width:0;">
                    <div class="kb-title" title="${kb.name}">${kb.name || 'Unnamed Knowledge Base'}</div>
                    <div class="kb-id">ID: ${kb.knowledgeBaseId}</div>
                  </div>
                  <div class="kb-info-icon" role="button" data-kb-id="${kb.knowledgeBaseId}" data-kb-name="${kb.name}" data-kb-description="${kb.description || 'No description available'}" data-kb-status="${kb.status || 'Unknown'}">‚ÑπÔ∏è</div>
                </div>
              `;
              
              // Add click handler for the entire item
              kbItem.addEventListener('click', (e) => {
                if (e.target.type !== 'radio' && !e.target.classList.contains('kb-info-icon')) {
                  const radio = kbItem.querySelector('input[type="radio"]');
                  radio.checked = true;
                }
                if (!e.target.classList.contains('kb-info-icon')) {
                  selectKnowledgeBase(kb.knowledgeBaseId, kb.name, kbItem);
                }
              });
              
              // Add radio button change handler
              const radio = kbItem.querySelector('input[type="radio"]');
              radio.addEventListener('change', () => {
                if (radio.checked) {
                  selectKnowledgeBase(kb.knowledgeBaseId, kb.name, kbItem);
                }
              });
              
              // Add info icon click handler
              const infoIcon = kbItem.querySelector('.kb-info-icon');
              infoIcon.addEventListener('click', (e) => {
                e.stopPropagation();
                showKBInfo(e, kb);
              });
              
              kbSelector.appendChild(kbItem);
            });
            
            kbSelector.style.display = 'grid';
            
          } else {
            kbSelector.innerHTML = '<div class="no-kb-message">No knowledge bases found in your AWS account</div>';
            kbSelector.style.display = 'block';
          }
          
        } catch (e) { 
          console.error('Error loading knowledge bases:', e);
          kbSelector.innerHTML = `<div style="color:#ef4444">Error loading knowledge bases: ${e.message}</div>`; 
          kbSelector.style.display = 'block'; 
        }
        
        loadKBBtn.textContent = 'üîç Load Available Knowledge Bases'; 
        loadKBBtn.disabled = false;
      }

      async function selectKnowledgeBase(kbId, kbName, element) {
        try {
          // Update visual selection
          kbSelector.querySelectorAll('.kb-item').forEach((item) => { 
            item.classList.remove('selected');
            const radio = item.querySelector('input[type="radio"]');
            if (radio) radio.checked = false;
          });
          
          element.classList.add('selected');
          const radio = element.querySelector('input[type="radio"]');
          if (radio) radio.checked = true;
          
          // Save to server
          const response = await fetch('/api/config/knowledge-base', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
              knowledgeBaseId: kbId, 
              knowledgeBaseName: kbName 
            })
          });
          
          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error || 'Failed to save KB configuration');
          }
          
          // Update the current KB display in the header
          const currentKB = document.getElementById('currentKB');
          if (currentKB) {
            currentKB.textContent = kbId;
          }
          
          showSaved();
          console.log(`Knowledge Base selected: ${kbName} (${kbId})`);
          
        } catch (error) {
          console.error('Error selecting knowledge base:', error);
          alert(`Failed to select knowledge base: ${error.message}`);
        }
      }

      function showKBInfo(event, kb) {
        // Remove any existing popup
        const existingPopup = document.querySelector('.kb-popup');
        if (existingPopup) {
          existingPopup.remove();
        }
        
        // Create popup
        const popup = document.createElement('div');
        popup.className = 'kb-popup visible';
        popup.innerHTML = `
          <div class="kb-popup-header">
            <div class="kb-popup-title">${kb.name || 'Unnamed Knowledge Base'}</div>
            <button class="kb-popup-close">‚úï</button>
          </div>
          <div class="kb-popup-body">
            ${kb.description || 'No description available'}
          </div>
          <div class="kb-popup-meta">
            <div><span class="kb-meta-label">ID:</span> <code>${kb.knowledgeBaseId}</code></div>
            <div><span class="kb-meta-label">Status:</span> <span class="kb-badge">${kb.status || 'Unknown'}</span></div>
            ${kb.createdAt ? `<div><span class="kb-meta-label">Created:</span> ${new Date(kb.createdAt).toLocaleDateString()}</div>` : ''}
          </div>
        `;
        
        document.body.appendChild(popup);
        
        // Position popup near the icon
        const iconRect = event.target.getBoundingClientRect();
        const popupRect = popup.getBoundingClientRect();
        
        let left = iconRect.left - popupRect.width + iconRect.width;
        let top = iconRect.top - popupRect.height - 10;
        
        // Adjust if popup goes off screen
        if (left < 10) left = 10;
        if (top < 10) top = iconRect.bottom + 10;
        if (left + popupRect.width > window.innerWidth - 10) {
          left = window.innerWidth - popupRect.width - 10;
        }
        
        popup.style.left = left + 'px';
        popup.style.top = top + 'px';
        
        // Add close handler
        const closeBtn = popup.querySelector('.kb-popup-close');
        const closePopup = () => popup.remove();
        closeBtn.addEventListener('click', closePopup);
        
        // Close on outside click
        setTimeout(() => {
          document.addEventListener('click', function outsideClick(e) {
            if (!popup.contains(e.target)) {
              closePopup();
              document.removeEventListener('click', outsideClick);
            }
          });
        }, 100);
      }

      async function loadFunctions() {
        try {
          const response = await fetch('/api/available-tools'); 
          if (!response.ok) throw new Error('Failed to load tools');
          const data = await response.json();
          
          functionsList.innerHTML = ''; 
          kbRetrieveFunction.innerHTML = '';
          
          (data.tools || []).forEach((tool) => {
            const toolItem = document.createElement('div'); 
            toolItem.className = 'tool-item';
            toolItem.innerHTML = `
              <div class="tool-info">
                <div class="tool-name">${tool.name}</div>
                <div class="tool-desc">${tool.description || ''}</div>
                ${tool.inputSchema ? `
                  <details class="tool-schema-details">
                    <summary>Input Schema</summary>
                    <pre class="tool-schema">${JSON.stringify(tool.inputSchema, null, 2)}</pre>
                  </details>
                ` : ''}
              </div>
              <label class="toggle-switch">
                <input type="checkbox" ${tool.enabled ? 'checked' : ''} data-tool="${tool.name}">
                <span class="toggle-track">
                  <span class="toggle-thumb"></span>
                </span>
              </label>
            `;
            
            if (tool.name === 'retrieveFromKnowledgeBase') {
              kbRetrieveFunction.appendChild(toolItem);
            } else {
              functionsList.appendChild(toolItem);
            }
          });
          
          // Set up event listeners for tool toggles
          document.querySelectorAll('input[type="checkbox"][data-tool]').forEach((checkbox) => {
            checkbox.addEventListener('change', async (e) => {
              const toolName = e.target.dataset.tool;
              const enabled = e.target.checked;
              
              try {
                // Update local config
                if (enabled) { 
                  if (!currentConfig.enabledTools.includes(toolName)) {
                    currentConfig.enabledTools.push(toolName); 
                  }
                } else { 
                  currentConfig.enabledTools = currentConfig.enabledTools.filter((t) => t !== toolName); 
                }
                
                // Save tool configuration
                const response = await fetch('/api/config/tools', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ enabledTools: currentConfig.enabledTools })
                });
                
                if (!response.ok) {
                  const errorData = await response.json();
                  throw new Error(errorData.error || 'Failed to save tool configuration');
                }
                
                console.log(`Tool ${toolName} ${enabled ? 'enabled' : 'disabled'}`);
                showSaved();
                
              } catch (error) {
                console.error('Error toggling tool:', error);
                // Revert the toggle on error
                e.target.checked = !enabled;
                alert(`Failed to update tool: ${error.message}`);
              }
            });
          });
          
          // Update current config with loaded enabled tools
          const enabledTools = (data.tools || []).filter(t => t.enabled).map(t => t.name);
          currentConfig.enabledTools = enabledTools;
          
        } catch (e) { 
          console.error('Error loading functions:', e);
          functionsList.innerHTML = `<div style="color:#ef4444">Failed to load functions: ${e.message}</div>`; 
        }
      }

      systemPrompt.addEventListener('input', updateCharCount);
      // chunkSizeSlider.addEventListener('input', updateChunkSize);
      resetBtn.addEventListener('click', () => { systemPrompt.value = DEFAULT_PROMPT; updateCharCount(); });
      form.addEventListener('submit', async (e) => { e.preventDefault(); await saveConfig(); });
      loadKBBtn.addEventListener('click', loadKnowledgeBases);
      document.getElementById('logoutBtn').addEventListener('click', handleLogout);
      
      (async function () { 
        updateCharCount(); 
        // updateChunkSize(); 
        await loadUserInfo();
        await hydrate(); 
        await loadFunctions();
        initializeCostTracking();
      })();
    </script>
</body>

</html>